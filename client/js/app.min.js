"use strict";function createNewStamp(){var a=Date.now();return a===last_stamp&&a++,last_stamp=a,a}angular.module("vassalApp.services",[]),angular.module("vassalApp.controllers",[]),angular.module("vassalApp.directives",[]),angular.module("vassalApp",["ui.router","vassalApp.controllers","vassalApp.services","vassalApp.directives"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("start",{url:"/",templateUrl:"partials/start.html",controller:"startCtrl",data:{}}).state("game",{url:"/game/:visibility/:id",templateUrl:"partials/game.html",controller:"gameCtrl",data:{}})}]).config(["$compileProvider",function(a){a.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|blob):/)}]),angular.module("vassalApp.controllers").controller("backupBoxCtrl",["$scope","$window",function(a,b){a.selection_save_url=null,a.generateSelectionBackup=function(){if(!(a.game.selection.length<=0)){var c=a.selection_save_url;a.selection_save_url=null,null!==c&&b.URL.revokeObjectURL(c);var d=a.game.models[a.game.selection[0]].state.x,e=a.game.models[a.game.selection[0]].state.y,f=_.map(a.game.selection,function(b){var c=a.game.models[b],f=_.omit(c.state,"id","x","y");return f.offset_x=c.state.x-d,f.offset_y=c.state.y-e,f.info=c.info,f}),g=JSON.stringify(f),h=new b.Blob([g],{type:"text/plain"}),i=b.URL.createObjectURL(h),j=Date.now();a.selection_save_name="models_"+j+".txt",a.selection_save_url=i}}}]),angular.module("vassalApp.controllers").controller("boardsBoxCtrl",["$scope","command",function(a,b){function c(){a.new_board=a.game.board.info?_.find(a.boards.list,function(b){return b.name===a.game.board.info.name}):null}a.$watch("game.board.info",c),c(),a.doSetBoard=function(){a.game.newCommand(b("setBoard",a.new_board))}}]),angular.module("vassalApp.controllers").controller("diceBoxCtrl",["$scope","command",function(a){a.showDiceCommands=function(a){var b=_.filter(a,function(a){return"sendMsg"===a.type&&"dice"===a.msg_type});return b}}]).controller("chatBoxCtrl",["$scope","command",function(a){a.chat_msg="",a.doSendMessage=function(){0>=a.chat_msg.length||(a.game.newChat(a.chat_msg),a.chat_msg="")},a.showChatCommands=function(a){var b=_.filter(a,function(a){return"sendMsg"===a.type&&"chat"===a.msg_type});return b}}]),angular.module("vassalApp.controllers").controller("clockBoxCtrl",["$scope","$window","command",function(a,b,c){a.doSwitchPlayer=function(){a.game.newCommand(c("onClock","switchPlayer"))},a.doStart=function(){a.game.newCommand(c("onClock","start"))},a.doStop=function(){a.game.newCommand(c("onClock","stop"))}}]),angular.module("vassalApp.controllers").controller("commandBoxCtrl",["$scope",function(a){a.selected={},a.$watch("game.replay_commands.length",function(){var a=document.getElementById("replay-commands");window.setTimeout(function(){a.scrollTop=a.scrollHeight},10)}),a.doUndoUpTo=function(){a.selected.stamp&&(a.game.undoCommandUpTo(a.selected.stamp),a.selected.stamp=null,a.selected.type=null)},a.doReplayUpTo=function(){a.selected.stamp&&(a.game.replayCommandUpTo(a.selected.stamp),a.selected.stamp=null,a.selected.type=null)}}]),angular.module("vassalApp.controllers").controller("createBoxCtrl",["$scope",function(a){a.model={faction:null,type:null,unit:null,unit_entry:null,id:null,size:1,info:[],number:null},a.$watch("model",function(){a.modes.current===a.modes.model_create&&a.modes.goTo("default",a)},!0),a.doToggleCreateModel=function(){if(a.modes.current===a.modes.model_create)return void a.modes.goTo("default");a.modes.goTo("model_create"),a.modes.model_create.info=[];var b=Math.ceil(a.model.size/2),c=3*a.model.id.r;_.times(a.model.size,function(d){var e=0,f=0;a.model.size<=5?(e=d*c-(a.model.size-1)*c/2,f=0):(e=d%b*c-(b-1)*c/2,f=d>=b?c:0),a.modes.model_create.info.push({info:a.model.id,offset_x:e,offset_y:f,unit:a.model.number})})}}]),angular.module("vassalApp.controllers").controller("dropBinBoxCtrl",["$scope","command",function(a,b){a.restore_selection={},a.isRestoreSelectionEmpty=function(){return 0===_.keys(a.restore_selection).length},a.doToggleRestoreSelection=function(b,c){var d=!c.ctrlKey;return d?(a.restore_selection={},void(a.restore_selection[b]=!0)):void(a.restore_selection[b]?delete a.restore_selection[b]:a.restore_selection[b]=!0)},a.doEmptySelection=function(){a.restore_selection={}},a.doRestoreSelection=function(){a.game.newCommand(b("restoreFromDropBin",_.keys(a.restore_selection)))},a.doRestoreAll=function(){a.game.newCommand(b("restoreFromDropBin",_.map(a.game.drop_bin,function(a){return a.state.id})))}}]),angular.module("vassalApp.controllers").controller("gameCtrl",["$scope","$state","$stateParams","$http","$q","$window","game","command","factions","modes",function(a,b,c,d,e,f,g,h,i,j){var k=document.getElementById("you-got-mail");a.doGoHome=function(){var c=!0;a.game.id&&(c=window.confirm("You're leaving the game.\r\nIf you want to save the game before, click Cancel.\r\n")),c&&b.go("start")},a.new_game_chat=!1,a.$on("game_chat",function(b,c){k.currentTime=0,k.play(),"main"!==a.menu_view&&(a.new_game_chat=!0)}),a.new_user_chat=!1;var l;a.$on("user_chat",function(b,c){a.user_chat=c,k.currentTime=0,k.play(),"games"!==a.menu_view&&(a.new_user_chat=!0),l&&window.clearTimeout(l),l=window.setTimeout(function(){a.user_chat=null,l=null,a.$digest()},2e3)}),a.setMenuView=function(b){a.menu_view=b,"games"===b&&(a.new_user_chat=!1),"main"===b&&(a.new_game_chat=!1)},a.modes=j,a.auras={0:{color:"none",name:"Off"},1:{color:"#0FF",name:"Cyan"},2:{color:"#F0F",name:"Purple"},3:{color:"#FF0",name:"Yellow"},4:{color:"#00F",name:"Blue"},5:{color:"#0F0",name:"Green"},6:{color:"#F00",name:"Red"}},a.effects={B:{icon:"/data/icons/Blind.png",name:"Blind"},C:{icon:"/data/icons/Corrosion.png",name:"Corrosion"},D:{icon:"/data/icons/BoltBlue.png",name:"Disrupt"},F:{icon:"/data/icons/Fire.png",name:"Fire"},I:{desc:"Incor- poreal",name:"Incorporeal"},K:{icon:"/data/icons/KD.png",name:"KD"},S:{icon:"/data/icons/Stationary.png",name:"Stationary"},T:{icon:"/data/icons/BoltYellow.png",name:"Fleeing"},W:{desc:"Wreck",name:"Wreck"}},a.model_selected_aura="0",a.model_selected_aoe="3",a.model_selected_melee="M",a.model_selected_area=5,a.model_selected_effect="F",a.force={},a.drag={start_x:0,start_y:0},a.model_view={},a.aoe={max_deviation:6},(!c.id||c.id.length<=0)&&b.go("start"),"private"!==c.visibility&&"public"!==c.visibility&&b.go("start"),a.menu_view="main",i.then(function(){return d.get("/api/games/"+("public"===c.visibility?"public/":"")+c.id).then(function(b){a.game=g(b.data)},function(a){return b.go("start"),e.reject()})},function(){return b.go("start"),e.reject()}).then(function(){var b=e.defer(),f=b.promise;return"private"!==c.visibility||a.game.player1.id===a.user.id||a.game.player2.id||(f=d.put("/api/games/"+a.game.id+"/player2",a.user).then(function(b){a.game.player2=b.data.player2},function(a){return e.reject()})),b.resolve(),f}).then(function(){function b(){return f?f:f=document.getElementById("canvas")}function c(b,c){a.modes.send(b,a,c).then(function(){c&&c.preventDefault(),"lock"!==a.force.ctrl&&(a.force.ctrl=!1),"lock"!==a.force.shift&&(a.force.shift=!1),"lock"!==a.force.alt&&(a.force.alt=!1)},function(){e()})}function e(){a.mode_display=!0,j&&window.clearTimeout(j),j=window.setTimeout(function(){a.mode_display=!1,j=null,a.$digest()},750)}a.game.board.window.width=window.innerHeight-5,a.game.board.window.height=window.innerHeight-5,window.onresize=function(){a.game.board.window.width=window.innerHeight-5,a.game.board.window.height=window.innerHeight-5,a.$digest()};var f=document.getElementById("canvas");a.show_ruler=a.game.ruler.state.active;var g={8:"Backspace",27:"Escape",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Delete",106:"Multiply",107:"Add",109:"Substract",110:"Point",111:"Divide",59:"SemiColon",61:"Equal",188:"Comma",189:"Dash",190:"Period",191:"ForwardSlash",219:"OpenBracket",220:"BackSlash",221:"CloseBracket",222:"SingleQuote"};a.onKeyDown=function(b){var d;if(b.keyCode>=48&&b.keyCode<=57||b.keyCode>=65&&b.keyCode<=90)d=String.fromCharCode(b.keyCode);else if(b.keyCode>=96&&b.keyCode<=105)d=String.fromCharCode(b.keyCode-48);else if(b.keyCode>=112&&b.keyCode<=120)d="F"+String.fromCharCode(b.keyCode-63);else if(b.keyCode>=121&&b.keyCode<=123)d="F1"+String.fromCharCode(b.keyCode-73);else{if(!_.has(g,b.keyCode))return;d=g[b.keyCode]}(b.shiftKey||a.force.shift)&&(d="Shift "+d),(b.ctrlKey||a.force.ctrl)&&(d="Ctrl "+d),(b.altKey||a.force.alt)&&(d="Alt "+d),c(d,b)},a.sendKey=function(b,d,e){e&&((d.shiftKey||a.force.shift)&&(b="Shift "+b),(d.ctrlKey||a.force.ctrl)&&(b="Ctrl "+b),(d.altKey||a.force.alt)&&(b="Alt "+b)),c(b,d)},a.stopKeyPropagation=function(a){a.stopPropagation()},a.onModelMouseDown=function(c,d){var e=b().getBoundingClientRect(),f=(c.clientX-e.left)/a.game.board.zoom.factor*480/a.game.board.window.width,g=(c.clientY-e.top)/a.game.board.zoom.factor*480/a.game.board.window.height;a.game.board.zoom.flipped&&(f=480-f,g=480-g),a.drag.state="starting",a.drag.start_x=f,a.drag.start_y=g,a.drag.event="Model",a.drag.target=d,c.stopPropagation()},a.onTemplateMouseDown=function(c,d){var e=b().getBoundingClientRect(),f=(c.clientX-e.left)/a.game.board.zoom.factor*480/a.game.board.window.width,g=(c.clientY-e.top)/a.game.board.zoom.factor*480/a.game.board.window.height;a.game.board.zoom.flipped&&(f=480-f,g=480-g),a.drag.state="starting",a.drag.start_x=f,a.drag.start_y=g,a.drag.event="Template",a.drag.target=d,c.stopPropagation()},a.onModelClick=function(){},a.onTemplateClick=function(){},a.doSelectStart=function(c){var d=b().getBoundingClientRect(),e=(c.clientX-d.left)/a.game.board.zoom.factor*480/a.game.board.window.width,f=(c.clientY-d.top)/a.game.board.zoom.factor*480/a.game.board.window.height;a.game.board.zoom.flipped&&(e=480-e,f=480-f),a.drag.state="starting",a.drag.start_x=e,a.drag.start_y=f,a.drag.event="Board"},a.doSelectMove=function(c){if("draging"===a.drag.state||"starting"===a.drag.state||a.modes.respondTo("MouseMove")){var d=b().getBoundingClientRect(),f=(c.clientX-d.left)/a.game.board.zoom.factor*480/a.game.board.window.width,g=(c.clientY-d.top)/a.game.board.zoom.factor*480/a.game.board.window.height;if(a.game.board.zoom.flipped&&(f=480-f,g=480-g),"draging"===a.drag.state||"starting"===a.drag.state){var h=f-a.drag.start_x,i=g-a.drag.start_y;return"starting"===a.drag.state&&(Math.abs(h)>.2||Math.abs(i)>.2)?(a.drag.state="draging",a.modes.send("DragStart",a,c,a.drag,h,i)["catch"](function(){e()})):"draging"===a.drag.state&&a.modes.send("Drag",a,c,a.drag,f,g,h,i)["catch"](function(){e()}),void a.$digest()}a.modes.send("MouseMove",a,c,f,g),a.$digest()}},a.doSelectStop=function(c){var d=b().getBoundingClientRect(),f=(c.clientX-d.left)/a.game.board.zoom.factor*480/a.game.board.window.width,g=(c.clientY-d.top)/a.game.board.zoom.factor*480/a.game.board.window.height;a.game.board.zoom.flipped&&(f=480-f,g=480-g);var h=a.drag.state;if(a.drag.state=null,"draging"===h){var i=f-a.drag.start_x,j=g-a.drag.start_y;a.modes.send("DragEnd",a,c,a.drag,f,g,i,j)["catch"](function(){e()})}else a.modes.send("Click",a,c,a.drag,f,g)["catch"](function(){"Board"!==a.drag.event&&e()})},a.modelShow=function(b){return a.game?_.filter(a.game.models,function(a){return a.state["show_"+b]}):[]},a.modelShowLabel=function(){return a.game?_.filter(a.game.models,function(a){return a.state.label.length>0}):[]},a.showCenteredAoE=function(){return a.game?_.filter(a.game.models,function(a){return a.state.show_aoe>0}):[]},a.showArea=function(){return a.game?_.filter(a.game.models,function(a){return a.state.show_area>0}):[]},a.templateShowLocked=function(b){return a.game?_.filter(a.game.templates[b],function(a){return a.locked}):[]},a.templateShowUnlocked=function(b){return a.game?_.filter(a.game.templates[b],function(a){return!a.locked}):[]},a.doSetUnit=function(){a.game.newCommand(h("onSelection","setUnit",a.model_view.unit))},a.doSetRandomSetup=function(){var b=Math.floor(Math.random()*a.scenarios.list.length),c=a.scenarios.list[b];a.game.newCommand(h("setScenario",c)),b=Math.floor(Math.random()*a.boards.list.length);var d=a.boards.list[b];a.game.newCommand(h("setBoard",d))},a.view_loc={top:0,left:0,width:a.game.board.window.width/8,height:a.game.board.window.height/8};var i=document.getElementById("canvas-container");i.onscroll=function(){a.view_loc.top=i.scrollTop/i.scrollHeight*a.game.board.window.height/8,a.view_loc.left=i.scrollLeft/i.scrollWidth*a.game.board.window.width/8,a.view_loc.height=a.game.board.window.height/8*(a.game.board.window.height/i.scrollHeight),a.view_loc.width=a.game.board.window.width/8*(a.game.board.window.width/i.scrollWidth),a.$digest()};var j;a.mode_display=!1,a.doInvitePlayer=function(){if(a.game.id&&_.isObject(a.player_invite)){var b={from:a.user.id,to:[a.player_invite.id],text:"#/game/private/"+a.game.id,type:"invite"};d.post("/api/users/chat",b).then(function(b){a.chat_msg=""},function(a){})}}})}]),angular.module("vassalApp.controllers").controller("gamesBoxCtrl",["$scope","$state",function(a,b){a.watch_game={},a.doWatchGame=function(){b.go("game",{visibility:"public",id:a.watch_game.id})}}]),angular.module("vassalApp.controllers").factory("importFKList",[function(){return function(a,b){var c=b.match(/[^\r\n]+/g);a.modes.model_create.info=[];var d=0,e=_.filter(a.game.models,function(a){return a.state.unit}).reduce(function(a,b){return Math.max(a,b.state.unit)},0),f=null,g=0,h=0;_.each(c,function(b){if(!b.match(/^(System:|Faction:|Casters:|Points:|Tiers:)/)&&(b=b.replace(/^\s*/,""),0!==b.length)){var c=!0,i=b.match(/^(\* )+/);i&&(c=!1,b=b.replace(/^(\* )+/,""));var j=1;i=b.match(/^(\d+) /),i&&(j=i[1]>>0,b=b.replace(/^\d+ /,"")),i=b.match(/\((\d+)\s.+?\)/i),i&&(j=i[1]>>0);var k=1;i=b.match(/(?:[\w]+) (?:and|&) (\d+) (?:[\w]+)/i),i&&(k=i[1]?(i[1]>>0)+1:2),i=b.match(/leader and grunts?/i),i&&(k=2),b=b.replace(/\s*\(.+\)\s*$/,"");var l=_.isObject(a.factions.fk_keys[b]);if(l){var m=a.factions.fk_keys[b];_.times(j,function(){{var b=0;_.keys(m).length}if(m.grunt){c&&e++,m.grunt.fk_size&&(k=m.grunt.fk_size);var i=Math.ceil(k/2),j=2.5*m.grunt.r,l=0;if(m.leader){var n=j/2,o=h;l=Math.max(l,n),a.modes.model_create.info.push({info:m.leader,offset_x:g+n,offset_y:o,show_leader:!0,unit:e}),b++,k--}_.times(k,function(){var c=0,d=0;5>=k?(c=b*j+j/2,d=h):(c=b%i*j+j/2,d=h+(b>=i?j:0)),l=Math.max(l,c),a.modes.model_create.info.push({info:m.grunt,offset_x:g+c,offset_y:d,show_leader:k>1&&0===b,unit:e}),b++}),g+=l+j/2,g>360&&(g=0,h=55),f=m.grunt.unit}m=_.omit(m,"grunt","leader"),_.keys(m).length>0&&_.each(m,function(d){d.unit&&c&&0===b&&e++;var i=d.fk_repeat||1;_.times(i,function(){a.modes.model_create.info.push({info:d,offset_x:g+1.25*d.r,offset_y:h,unit:d.unit?e:void 0}),g+=2.5*d.r,g>360&&(g=0,h=55),b++}),f=d.unit}),d+=b})}else a.fk_read_result.push('!!! unknown model "'+b+'"')}}),d>0&&a.modes.goTo("model_create",a)}}]).controller("importBoxCtrl",["$scope","$window",function(a,b){a.readModelFile=function(c){a.modes.goTo("default",a),a.read_result=[];var d=new b.FileReader;d.onload=function(b){a.read_result.push("loaded file");var c;try{c=JSON.parse(b.target.result)}catch(d){a.read_result.push("invalid file format")}a.modes.model_create.info=c,a.modes.goTo("model_create",a),a.$digest()},d.onerror=function(){a.read_result=["error reading file"],a.$digest()},d.onabort=function(){a.read_result=["abort reading file"],a.$digest()},d.readAsText(c)};var c=document.getElementById("import-model-file");c.onchange=function(){a.readModelFile(c.files[0])}}]).controller("importFKBoxCtrl",["$scope","$window","importFKList",function(a,b,c){a.fk_read_result=[],a.fk_read_string="",a.readFKFile=function(d){a.modes.goTo("default",a),a.fk_read_result=[];var e=new b.FileReader;e.onload=function(b){a.fk_read_result.push("loaded file");var d=b.target.result;c(a,d),a.$digest()},e.onerror=function(){a.fk_read_result=["error reading file"],a.$digest()},e.onabort=function(){a.fk_read_result=["abort reading file"],a.$digest()},e.readAsText(d)},a.readFKString=function(){a.modes.goTo("default",a),a.fk_read_result=[],c(a,a.fk_read_string)};var d=document.getElementById("import-fk-file");d.onchange=function(){a.readFKFile(d.files[0])}}]).controller("netdeckBoxCtrl",["$scope","$http","importFKList",function(a,b,c){a.fk_read_result=[],a.fk_read_string="",a.doImportNetdeckList=function(){a.netdeck_faction&&a.netdeck_list&&b.get(a.netdeck_list).then(function(b){c(a,b.data)},function(a){})}}]),angular.module("vassalApp.controllers").controller("layersBoxCtrl",["$scope","command",function(a,b){a.onLayerChange=function(c){a.game.newCommand(b("setLayer",c))}}]),angular.module("vassalApp.controllers").controller("mainCtrl",["$scope","$rootScope","$state","$http","factions","netdeck","scenarios","boards","games","users","user",function(a,b,c,d,e,f,g,h,i,j,k){e.then(function(a){b.factions=a}),g.then(function(a){b.scenarios=a}),h.then(function(a){b.boards=a}),a.range=function(a){var b=[];return _.isNumber(a)&&_.times(a,function(a){b.push(a)}),b},a.user=k,a.users=j,a.games=i,a.netdeck=f,a.doGoHome=function(){c.go("start")}}]),angular.module("vassalApp.controllers").controller("modelViewBoxCtrl",["$scope","$state","$stateParams","$http","$q","$window","game","command","factions","modes",function(a,b,c,d,e,f,g,h){a.doSetLabel=function(){a.game.newCommand(h("onSelection","setLabel",a.model_view.new_label)),a.model_view.new_label=null},a.doClearLabel=function(b){a.game.newCommand(h("onSelection","clearLabel",b))},a.doClearAllLabel=function(){a.game.newCommand(h("onSelection","clearAllLabel"))},a.doModelDamage=function(b,c,d){a.game.id&&a.game.newCommand(h("onSelection","toggleDamage",c,d))},a.doResetAllModelDamage=function(){a.game.newCommand(h("onSelection","resetAllDamage"))}}]),angular.module("vassalApp.controllers").controller("scenariosBoxCtrl",["$scope","command",function(a,b){function c(){a.new_scenario=a.game.scenario?_.find(a.scenarios.list,function(b){return b.name===a.game.scenario.name}):null}a.$watch("game.scenario",c),c(),a.doSetScenario=function(){a.game.newCommand(b("setScenario",a.new_scenario))},a.doSetRandomScenario=function(){var b=Math.floor(Math.random()*a.scenarios.list.length);a.new_scenario=a.scenarios.list[b],a.doSetScenario()},a.doGenerateObjectives=function(){if(a.game.scenario){var c=_.filter(a.game.models,function(a){return"objective"===a.info.type||"flag"===a.info.type}).map(function(a){return a.state.id});c.length>0&&(a.game.newCommand(b("setSelection",c)),a.game.newCommand(b("dropSelection")));var d=[];_.each(a.game.scenario.objectives,function(b){d.push({info:a.factions.list.scenario.models.objectives[b.type],x:b.x,y:b.y})}),_.each(a.game.scenario.flags,function(b){d.push({info:a.factions.list.scenario.models.flags[b.type],x:b.x,y:b.y})}),a.game.newCommand(b("createModel",d))}}}]),angular.module("vassalApp.controllers").controller("startCtrl",["$scope","$state","$window","$http",function(a,b,c,d){var e=document.getElementById("you-got-mail");a.$on("user_chat",function(a,b){e.currentTime=0,e.play()}),a.doCreateGame=function(){a.creating=!0,d.post("/api/games",{player1:a.user}).then(function(a){b.go("game",{visibility:"private",id:a.data.id})},function(a){})["finally"](function(){a.creating=!1})},a.doSearchGame=function(){b.go("game",{visibility:"private",id:a.search_id})},a.read_result="",a.readBackup=function(e){a.read_result=null,a.creating=!0;var f=new c.FileReader;f.onload=function(c){var e;try{e=JSON.parse(c.target.result),a.read_result="file valid, uploading to server...";var f=_.pick(e,"clock","models","commands","replay_commands");f.clock&&_.extend(f.clock,{state:"stopped"}),f.player1=a.user,d.post("/api/games",f).then(function(a){b.go("game",{visibility:"private",id:a.data.id})},function(a){})["finally"](function(){a.creating=!1})}catch(g){a.read_result="invalid file",a.creating=!1}a.$digest()},f.onerror=function(){a.read_result="error reading file",a.creating=!1,a.$digest()},f.onabort=function(){a.read_result="abort reading file",a.creating=!1,a.$digest()},f.readAsText(e)},a.doCreateUser=function(){a.user.id?a.user.refresh():a.user.create()}}]),angular.module("vassalApp.controllers").controller("templateViewBoxCtrl",["$scope","$state","$stateParams","$http","$q","$window","game","command","factions","modes",function(a,b,c,d,e,f,g,h){a.doSetLabel=function(){a.game.newCommand(h("onActiveTemplate","setLabel",a.template_view.new_label)),a.template_view.new_label=null},a.doClearLabel=function(b){a.game.newCommand(h("onActiveTemplate","clearLabel",b))},a.doClearAllLabel=function(){a.game.newCommand(h("onActiveTemplate","clearAllLabel"))}}]),angular.module("vassalApp.controllers").controller("toolsBoxCtrl",["$scope",function(a){a.doToggleMode=function(b){a.modes.current.group===a.modes[b].group?a.modes.goTo("default",a):a.modes.goTo(b,a)},a.doCreateTemplate=function(b,c){a.modes.template_create.type=b,a.modes.template_create.size=c,a.modes.template_create.x=240,a.modes.template_create.y=240,a.modes.goTo("template_create",a)}}]),angular.module("vassalApp.controllers").controller("unitsBoxCtrl",["$scope",function(a){a.units={},_.each(a.game.models,function(b){b.state.unit&&(a.units[b.state.unit]=a.units[b.state.unit]||[],a.units[b.state.unit].push(b))})}]),angular.module("vassalApp.controllers").controller("usersBoxCtrl",["$scope","$http",function(a,b){a.selection={},a.toggleSelection=function(b){b!==a.user.id&&(a.selection[b]=!a.selection[b],a.selection[b]||delete a.selection[b],a.selection_length=_.keys(a.selection).length)},a.selectAll=function(){_.each(a.users.list,function(b){b.id!==a.user.id&&(a.selection[b.id]=!0)}),a.selection_length=_.keys(a.selection).length},a.clearSelection=function(){_.each(a.selection,function(b,c){delete a.selection[c]}),a.selection_length=0},a.doSelectionFromMsg=function(b){var c=[b.from].concat(b.to);c=_.without(c,a.user.id),a.selection={},_.each(c,function(b){a.selection[b]=!0}),a.selection_length=_.keys(a.selection).length},a.doSendChatMsg=function(){var c=_.keys(a.selection).map(function(a){return a>>0});if(0!==c.length&&0!==a.chat_msg.length){var d={from:a.user.id,to:c,text:a.chat_msg};b.post("/api/users/chat",d).then(function(b){a.chat_msg=""},function(a){})}}}]),angular.module("vassalApp.directives").directive("boardMove",function(){return{restrict:"A",controller:["$scope",function(){}],link:function(a,b){b[0].onmousedown=function(b){a.doSelectStart(b)},b[0].onmousemove=function(b){a.doSelectMove(b)},b[0].onmouseup=function(b){a.doSelectStop(b),a.$apply()}}}}).directive("modelMove",function(){return{restrict:"A",controller:["$scope",function(){}],link:function(a,b){b[0].onmousedown=function(b){a.onModelMouseDown(b,a.model)},b[0].onmouseup=function(b){a.doSelectStop(b,a.model),a.$apply()}}}}).directive("templateMove",function(){return{restrict:"A",controller:["$scope",function(){}],link:function(a,b){b[0].onmousedown=function(b){a.onTemplateMouseDown(b,a.tp)},b[0].onmouseup=function(b){a.doSelectStop(b),a.$apply()}}}}),_.mixin({deepCopy:function a(b){function c(b){return _.isObject(b)&&!_.isFunction(b)?a(b):b}var d;return _.isArray(b)?d=_.map(b,c):(d={},_.each(b,function(a,b){d[b]=c(a)})),d}}),_.mixin({deepExtend:function b(a,c){return _.each(c,function(c,d){!_.isObject(c)||_.isArray(c)||_.isFunction(c)||!_.isObject(a[d])||_.isArray(a[d])||_.isFunction(a[d])?a[d]=c:b(a[d],c)}),a}}),angular.module("vassalApp.services").factory("boards",["$http","$q",function(a,b){var c={};return a.get("/data/boards.json").then(function(a){return c.list=a.data,c},function(a){return b.reject(a)})}]),angular.module("vassalApp.services").factory("clock",[function(){function a(){var a=this.time;this.hour=Math.floor(a/36e5),a-=60*this.hour*60*1e3,this.minute=Math.floor(a/6e4),a-=60*this.minute*1e3,this.second=Math.floor(a/1e3)}function b(){this.time=1e3*(60*(60*this.hour+this.minute)+this.second)}return function(){var c={reserve:{hour:1,minute:0,second:0,time:0,time2clock:a,clock2time:b},left:{hour:1,minute:0,second:0,time:0,time2clock:a,clock2time:b},start_time:0,isValid:function(){return this.reserve.hour>=0&&this.reserve.minute>=0&&this.reserve.second>=0},start:function(){this.reserve.clock2time(),this.start_time=Date.now(),this.update()},update:function(){this.left.time=this.reserve.time;var a=Date.now(),b=a-c.start_time;this.left.time-=b,this.left.time=Math.max(0,this.left.time),this.left.time2clock()},stop:function(){this.update(),this.reserve.time=this.left.time,this.reserve.time2clock()}};return c}}]);var last_stamp;angular.module("vassalApp.services").factory("command_onClock",[function(){var a=function(){var a=Array.prototype.slice.call(arguments,0),b={type:"onClock",stamp:createNewStamp(),method:null,before:null,after:null,do_not_log:!0,execute:function(b){this.before=_.deepCopy(b.clock),b.clock[this.method].apply(b.clock,a.slice(1)),this.after=_.deepCopy(b.clock)},redo:function(a){a.clock.checkForUpdate(this.after)},undo:function(){},desc:function(){return this.type+"("+this.method+")"}};return 1===a.length&&_.isObject(a[0])?_.extend(b,a[0]):b.method=a[0],b};return a}]).factory("command_sendMsg",["template",function(){var a=function(a){var b=Array.prototype.slice.call(arguments),c={type:"sendMsg",stamp:createNewStamp(),msg_type:null,msg_text:null,execute:function(){},redo:function(){},undo:function(){},desc:function(){return this.type+"("+this.msg_type+")"}};return 1===b.length?_.extend(c,a):(c.msg_type=b[0],c.msg_text=b[1]),c};return a}]).factory("command_setBoard",["template",function(){var a=function(a){var b={type:"setBoard",stamp:createNewStamp(),before:null,after:null,execute:function(b){this.before=b.board.info?_.deepCopy(b.board.info):null,b.board.info=a,this.after=_.deepCopy(b.board.info)},redo:function(a){a.board.info=_.deepCopy(this.after)},undo:function(a){a.board.info=_.deepCopy(this.before)},desc:function(){return this.type+"("+this.after.name+")"}};return _.isNumber(a.stamp)&&_.extend(b,a),b};return a}]).factory("command_setScenario",["template",function(){var a=function(a){var b={type:"setScenario",stamp:createNewStamp(),before:null,after:null,execute:function(b){this.before=b.scenario?_.deepCopy(b.scenario):null,b.scenario=a,this.after=_.deepCopy(b.scenario)},redo:function(a){a.scenario=_.deepCopy(this.after)},undo:function(a){a.scenario=_.deepCopy(this.before)},desc:function(){return this.type+"("+this.after.name+")"}};return _.isNumber(a.stamp)&&_.extend(b,a),b};return a}]).factory("command_createTemplate",["template",function(a){var b=function(b){var c={type:"createTemplate",stamp:createNewStamp(),options:null,after:null,execute:function(a){var b=a.createTemplate(this.options);this.after=_.deepCopy(b)},redo:function(a){a.templates[this.after.type][this.after.stamp]=_.deepCopy(this.after)},undo:function(a){a.templates.active===a.templates[this.after.type][this.after.stamp]&&(a.templates.active=null),delete a.templates[this.after.type][this.after.stamp]},desc:function(){return this.type+"("+this.options.type+")"}};return _.isNumber(b.stamp)?(_.extend(c,b),a(c.after)):c.options=_.deepCopy(b),c};return b}]).factory("command_deleteActiveTemplate",["template",function(a){var b=function(b){var c={type:"deleteActiveTemplate",stamp:createNewStamp(),before:null,execute:function(a){this.before=_.deepCopy(a.templates.active),a.templates.active=null,delete a.templates[this.before.type][this.before.stamp]},redo:function(a){a.templates.active===a.templates[this.before.type][this.before.stamp]&&(a.templates.active=null),delete a.templates[this.before.type][this.before.stamp]},undo:function(a){a.templates[this.before.type][this.before.stamp]=_.deepCopy(this.before)},desc:function(){return this.type+"("+this.before.type+")"}};return b&&(_.extend(c,b),a(c.before)),c};return b}]).factory("command_onActiveTemplate",[function(){var a=function(){var a=Array.prototype.slice.call(arguments,0),b={type:"onActiveTemplate",stamp:createNewStamp(),method:null,before:null,after:null,execute:function(b){var c=[b].concat(a.slice(1));this.before=_.deepCopy(b.templates.active),b.templates.active[this.method].apply(b.templates.active,c),this.after=_.deepCopy(b.templates.active)},redo:function(a){_.deepExtend(a.templates[this.after.type][this.after.stamp],this.after)},undo:function(a){_.deepExtend(a.templates[this.before.type][this.before.stamp],this.before)},desc:function(){return this.type+"("+this.method+")"}};return 1==a.length&&_.isObject(a[0])?_.extend(b,a[0]):b.method=a[0],b};return a}]).factory("command_dragActiveTemplate",[function(){var a=function(){var a=Array.prototype.slice.call(arguments,0),b={type:"dragActiveTemplate",stamp:createNewStamp(),before:null,after:null,execute:function(b){var c=[b].concat(a);this.before=_.deepCopy(b.templates.active.startDraging.ref),b.templates.active.draging.apply(b.templates.active,c),this.after=_.deepCopy(b.templates.active)},redo:function(a){_.deepExtend(a.templates[this.after.type][this.after.stamp],this.after)},undo:function(a){_.deepExtend(a.templates[this.before.type][this.before.stamp],this.before)},desc:function(){return this.type}};return 1==a.length&&_.isObject(a[0])&&_.extend(b,a[0]),b};return a}]).factory("command_createModel",["model",function(a){var b=function(b){var c={type:"createModel",stamp:createNewStamp(),before:null,after:null,execute:function(a){var c=a.createModel(b);this.after=c},redo:function(a){_.each(this.after,function(b){a.models[b.state.id]=b}),a.update_selection=_.map(this.after,function(a){return a.state.id})},undo:function(a){var b=_.map(this.after,function(a){return a.state.id});a.selection=_.without.apply(_,[a.selection].concat(b)),a.update_selection=_.without.apply(_,[a.update_selection].concat(b)),_.each(this.after,function(b){delete a.models[b.state.id]})},desc:function(){return this.type}};return _.isArray(b)||(_.extend(c,b),_.each(c.after,function(b){a(b)})),c};return b}]).factory("command_setLayer",[function(){var a=function(a){var b={type:"setLayer",stamp:createNewStamp(),arg:null,before:null,after:null,execute:function(a){this.before=_.extend({},a.layers),this.before[this.arg]=!this.before[this.arg],this.after=_.extend({},a.layers)},redo:function(a){_.extend(a.layers,this.after)},undo:function(a){_.extend(a.layers,this.before)},desc:function(){return this.type+"("+this.arg+")"}};return _.isString(a)?b.arg=a:_.extend(b,a),b};return a}]).factory("command_setRuler",[function(){var a=function(a){var b={type:"setRuler",stamp:createNewStamp(),before:null,after:null,execute:function(a){this.after=_.extend({},a.ruler.state)},redo:function(a){_.extend(a.ruler.state,this.after)},undo:function(a){_.extend(a.ruler.state,this.before)},desc:function(){return this.type+"("+this.after.active+")"}};return _.isNumber(a.stamp)?_.extend(b,a):b.before=_.extend({},a),b};return a}]).factory("command_onLos",[function(){var a=function(a){var b=Array.prototype.slice.call(arguments,0),c={type:"onLos",stamp:createNewStamp(),method:null,before:null,after:null,execute:function(a){this.before=_.deepCopy(a.los.state),a.los[this.method].apply(a.los,b.slice(1)),this.after=_.deepCopy(a.los.state)},redo:function(a){_.extend(a.los.state,this.after)},undo:function(a){_.extend(a.los.state,this.before)},desc:function(){return this.type+"("+this.method+")"}};return _.isNumber(a.stamp)?_.extend(c,a):c.method=a,c};return a}]).factory("command_onSelection",[function(){var a=function(){var a=Array.prototype.slice.call(arguments,0),b={type:"onSelection",stamp:createNewStamp(),method:null,before:null,after:null,execute:function(b){this.before=_.map(b.selection,function(a){return _.deepCopy(b.models[a].state)}),b.onSelection.apply(b,a),this.after=_.map(b.selection,function(a){return _.deepCopy(b.models[a].state)})},redo:function(a){_.each(this.after,function(b){a.models[b.id]&&(a.models[b.id].state=_.deepCopy(b))}),a.update_selection=_.map(this.after,function(a){return a.id})},undo:function(a){_.each(this.before,function(b){a.models[b.id]&&(a.models[b.id].state=_.deepCopy(b))}),a.update_selection=_.map(this.before,function(a){return a.id})},desc:function(){return this.type+"("+this.method+")"
}};return 1==a.length&&_.isObject(a[0])?_.extend(b,a[0]):b.method=a[0],b};return a}]).factory("command_endDragingSelection",[function(){var a=function(){var a=Array.prototype.slice.call(arguments,0),b={type:"endDragingSelection",stamp:createNewStamp(),before:null,after:null,execute:function(b){this.before=_.map(b.selection,function(a){return _.deepCopy(b.models[a].state_before_drag)}),b.onSelection.apply(b,["endDraging"].concat(a)),this.after=_.map(b.selection,function(a){return _.deepCopy(b.models[a].state)})},redo:function(a){_.each(this.after,function(b){a.models[b.id]&&(a.models[b.id].state=_.deepCopy(b))}),a.update_selection=_.map(this.after,function(a){return a.id})},undo:function(a){_.each(this.before,function(b){a.models[b.id]&&(a.models[b.id].state=_.deepCopy(b))}),a.update_selection=_.map(this.before,function(a){return a.id})},desc:function(){return this.type}};return 1==a.length&&_.isObject(a[0])&&_.extend(b,a[0]),b};return a}]).factory("command_dropSelection",[function(){var a=function(){var a={type:"dropSelection",stamp:createNewStamp(),before:null,execute:function(a){this.before=[].concat(a.selection),a.dropModels(this.before)},redo:function(a){a.dropModels(this.before)},undo:function(a){a.restoreFromDropBin(this.before),a.update_selection=this.before},desc:function(){return this.type}},b=Array.prototype.slice.call(arguments,0);return 1==b.length&&_.extend(a,b[0]),a};return a}]).factory("command_restoreFromDropBin",[function(){var a=function(){var a={type:"restoreFromDropBin",stamp:createNewStamp(),args:null,execute:function(a){a.restoreFromDropBin(this.args)},redo:function(a){a.restoreFromDropBin(this.args),a.update_selection=this.args},undo:function(a){a.dropModels(this.args)},desc:function(){return this.type}},b=Array.prototype.slice.call(arguments,0);return _.isArray(b[0])?a.args=b[0]:_.extend(a,b[0]),a};return a}]).factory("command_setSelection",[function(){var a=function(a){var b={type:"setSelection",stamp:createNewStamp(),before:null,after:null,do_not_log:!0,execute:function(b){this.before=[].concat(b.selection),b.setSelection(a),this.after=[].concat(b.selection)},redo:function(a){a.update_selection=this.after},undo:function(a){a.update_selection=this.before},desc:function(){return this.type}};return _.isArray(a)||_.extend(b,a),b};return a}]).factory("command_addToSelection",[function(){var a=function(a){var b={type:"addToSelection",stamp:createNewStamp(),before:null,after:null,do_not_log:!0,execute:function(b){this.before=[].concat(b.selection),b.addToSelection(a),this.after=[].concat(b.selection)},redo:function(a){a.update_selection=this.after},undo:function(a){a.update_selection=this.before},desc:function(){return this.type}};return _.isArray(a)||_.extend(b,a),b};return a}]).factory("command_removeFromSelection",[function(){var a=function(a){var b={type:"removeFromSelection",stamp:createNewStamp(),before:null,after:null,do_not_log:!0,execute:function(b){this.before=[].concat(b.selection),b.removeFromSelection(a),this.after=[].concat(b.selection)},redo:function(a){a.update_selection=this.after},undo:function(a){a.update_selection=this.before},desc:function(){return this.type}};return _.isArray(a)||_.extend(b,a),b};return a}]).factory("command",["command_onClock","command_sendMsg","command_setBoard","command_setScenario","command_createTemplate","command_deleteActiveTemplate","command_onActiveTemplate","command_dragActiveTemplate","command_createModel","command_setLayer","command_setRuler","command_onLos","command_onSelection","command_endDragingSelection","command_dropSelection","command_restoreFromDropBin","command_setSelection","command_addToSelection","command_removeFromSelection",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){var t={onClock:a,sendMsg:b,setBoard:c,setScenario:d,createTemplate:e,deleteActiveTemplate:f,onActiveTemplate:g,dragActiveTemplate:h,createModel:i,setLayer:j,setRuler:k,onLos:l,onSelection:m,endDragingSelection:n,dropSelection:o,restoreFromDropBin:p,setSelection:q,addToSelection:r,removeFromSelection:s},u=function(){var a=Array.prototype.slice.call(arguments,0),b="";if(1!=a.length||_.isString(a[0])){if(!_.isString(a[0]))return;b=a[0],a=a.slice(1)}else{if(!_.isObject(a[0])||!_.isString(a[0].type))return;b=a[0].type}return _.isFunction(t[b])?t[b].apply(null,a):void 0};return u}]),angular.module("vassalApp.services").factory("factions",["$http","$q",function(a,b){function c(a,b,c){function f(a,b){return _.reduce(b,function(b,c){return b+_.reduce(a[c],function(a,b){return a+(b?1:0)},0)},0)}switch(b.r=d[b.base],b.color=c.color,"jack"===b.type&&(b.img.wreck=c.wreck?c.wreck[b.base]:null),b.damage.type){case"jack":case"beast":case"gargantuan":b.damage.total=f(b.damage,["1","2","3","4","5","6"]),b.damage.depth=b.damage[1].length;break;case"colossal":b.damage.total=f(b.damage,["L1","L2","L3","L4","L5","L6","R1","R2","R3","R4","R5","R6"]);break;case"warrior":b.damage.total=b.damage.n}_.isArray(b.fk_name)&&_.each(b.fk_name,function(c){_.isString(c)&&(e.fk_keys[c]=e.fk_keys[c]||{},e.fk_keys[c][a]=b)}),_.isString(b.fk_name)&&(e.fk_keys[b.fk_name]=e.fk_keys[b.fk_name]||{},e.fk_keys[b.fk_name][a]=b)}var d={huge:24.605,large:9.842,medium:7.874,small:5.905},e={};return a.get("/data/factions.json").then(function(c){e.list=c.data;var d=_.map(e.list,function(b){return a.get(b)});return b.all(d)},function(a){return b.reject(a)}).then(function(a){var b=_.invert(e.list);return _.each(a,function(a){e.list[b[a.config.url]]=a.data,e.fk_keys={},_.each(e.list,function(a){_.each(a.models,function(b){_.each(b,function(b,d){b.entries?_.each(b.entries,function(d){_.each(d,function(d,e){c(e,d,a),d.unit=b.name})}):c(d,b,a)})})})}),e},function(a){return b.reject(a)})}]),angular.module("vassalApp.services").factory("game",["$rootScope","$http","$window","$q","model","template","command","user","twoPlayerClock",function(a,b,c,d,e,f,g,h,i){function j(a,b){var c=b.x-a.state.x,d=b.y-a.state.y;return Math.sqrt(c*c+d*d)<=a.info.r+b.r}function k(b,c){var d=a.factions.list.scenario.models.flags[c.type].r,e=c.x-b.state.x,f=c.y-b.state.y;return Math.sqrt(e*e+f*f)<=b.info.r+40+d}function l(a,b){var c,d;return a.state.x>=b.x-b.width/2&&a.state.x<=b.x+b.width/2&&a.state.y>=b.y-b.height/2&&a.state.y<=b.y+b.height/2?!0:a.state.x+a.info.r>=b.x-b.width/2&&a.state.x<b.x-b.width/2?(c=b.x-b.width/2-a.state.x,d=Math.sqrt(a.info.r*a.info.r-c*c),a.state.y+d>=b.y-b.height/2&&a.state.y-d<=b.y+b.height/2):a.state.x-a.info.r<=b.x+b.width/2&&a.state.x>b.x+b.width/2?(c=b.x+b.width/2-a.state.x,d=Math.sqrt(a.info.r*a.info.r-c*c),a.state.y+d>=b.y-b.height/2&&a.state.y-d<=b.y+b.height/2):a.state.y+a.info.r>=b.y-b.height/2&&a.state.y<b.y-b.height/2?(d=b.y-b.height/2-a.state.y,c=Math.sqrt(a.info.r*a.info.r-d*d),a.state.x+c>=b.x-b.width/2&&a.state.x-c<=b.x+b.width/2):a.state.y-a.info.r<=b.y+b.height/2&&a.state.y>b.y+b.height/2?(d=b.y+b.height/2-a.state.y,c=Math.sqrt(a.info.r*a.info.r-d*d),a.state.x+c>=b.x-b.width/2&&a.state.x-c<=b.x+b.width/2):!1}var m=e({}),n=null,o=function(o){function p(){var b="/api/games/"+(q.id?"":"public/")+(q.id?q.id:q.public_id)+"/commands/subscribe";(h.wall||q.commands.length>0)&&(b+="?"),h.wall&&(b+="close=true",q.commands.length>0&&(b+="&")),q.commands.length>0&&(b+="last="+_.last(q.commands).stamp),n&&n.close(),n=new EventSource(b),n.onmessage=function(b){var c,d=JSON.parse(b.data);_.isArray(d.slice)?(_.each(d.slice,function(a){c=g(a),q.updateCommand(c)}),d.more||(q.loading=!1,a.$digest())):(c=g(d),q.updateCommand(c),q.loading=!1,a.$digest())},n.addEventListener("undo",function(b){var c=JSON.parse(b.data);if(c.stamp===_.last(q.commands).stamp){var d=q.commands.pop();d.undo(q),q.replay_commands.push(d)}a.$digest()}),n.addEventListener("game",function(b){var c=JSON.parse(b.data);q.player1=c.player1,q.player2=c.player2,a.$digest()}),n.onerror=function(a){return a.target.readyState===a.target.CLOSED?void window.alert("The connection with the server is lost\nSave your game, then try to reload the page.\n"):(n.close(),void p())}}var q={loading:!0,clock:null,scenario:null,contestingModels:function(){return q.scenario?_.filter(q.models,function(a){var b=_.reduce(q.scenario.circle,function(b,c){return b||j(a,c)},!1);return b=b||_.reduce(q.scenario.flags,function(b,c){return b||k(a,c)},b),b=b||_.reduce(q.scenario.rect,function(b,c){return b||l(a,c)},b)}).map(function(a){return a.state.id}):[]},new_model_id:0,models:{},createModel:function(a){var b=[];return _.each(a,function(a){var c=_.omit(a,"info"),d=e(q.new_model_id++,a.info,c);d.refresh(q),q.models[d.state.id]=d,b.push(d)}),b},drop_bin:{},selection:[],update_selection:[],onSelection:function(a){if(_.isFunction(m[a])){var b=Array.prototype.slice.call(arguments,1);_.each(this.selection,function(c){q.models[c][a].apply(q.models[c],[q].concat(b))})}},addToSelection:function(a){this.selection=_.uniq(this.selection.concat(a))},removeFromSelection:function(a){this.selection=_.without.apply(_,[this.selection].concat(a))},setSelection:function(a){this.clearSelection(),this.addToSelection(a)},clearSelection:function(){this.selection.length=0},dropModels:function(a){this.selection=_.without.apply(_,[this.selection].concat(a)),this.update_selection=_.without.apply(_,[this.update_selection].concat(a)),_.each(a,function(a){_.has(q.models,a)&&(q.drop_bin[a]=q.models[a],delete q.models[a])})},restoreFromDropBin:function(a){_.each(a,function(a){_.has(q.drop_bin,a)&&(q.models[a]=q.drop_bin[a],delete q.drop_bin[a])})},templates:{aoe:{},spray:{},wall:{},active:null},createTemplate:function(a){var b=f(a);return this.templates[b.type][b.stamp]=b,this.templates.active=b,b},replay_commands:[],new_commands:[],commands:[],chat_commands:[],newChat:function(a){var c=g("sendMsg","chat",a);c.do_not_log=!0,c.user=h.name,c.execute(this),this.new_commands.push(c),b.post("/api/games/public/"+q.public_id+"/chat",c).then(function(){},function(a){})},newCommand:function(a){a.user=h.name,a.execute(this),q.id&&(this.new_commands.push(a),b.post("/api/games/"+q.id+"/commands",a).then(function(){},function(a){}))},undoCommand:function(a){return a>=this.commands.length?void 0:b.put("/api/games/"+this.id+"/commands/undo",{stamp:this.commands[a].stamp}).then(function(a){return a},function(a){return d.reject(a)})},undoLastCommand:function(){this.commands.length<=0||this.undoCommand(this.commands.length-1)},undoAllCommands:function(a){return void 0===a?this.undoAllCommands(this.commands.length):void(0>=a||this.undoCommand(a-1).then(function(){a--,q.undoAllCommands(a)}))},_undoCommandUpTo:function(a,b){this.commands.length<=0||this.commands[b-1].stamp!==a&&this.undoCommand(b-1).then(function(){b--,q._undoCommandUpTo(a,b)})},undoCommandUpTo:function(a){var b=_.find(this.commands,function(b){return b.stamp===a});b&&this._undoCommandUpTo(a,this.commands.length)},replayCommand:function(a){if(!(a>=this.replay_commands.length)){var c=this.replay_commands[a];return b.post("/api/games/"+q.id+"/commands",c).then(function(a){return a},function(a){return d.reject(a)})}},replayNextCommand:function(){0>=this.replay_commands.length||this.replayCommand(this.replay_commands.length-1)},replayAllCommands:function(a){return void 0===a?this.replayAllCommands(this.replay_commands.length):void(0>=a||this.replayCommand(a-1).then(function(){a--,q.replayAllCommands(a)}))},_replayCommandUpTo:function(a,b){if(!(this.replay_commands.length<=0)){var c=this.replay_commands[b-1].stamp===a;this.replayCommand(b-1).then(function(){c||(b--,q._replayCommandUpTo(a,b))})}},replayCommandUpTo:function(a){var b=_.find(this.replay_commands,function(b){return b.stamp===a});b&&this._replayCommandUpTo(a,this.replay_commands.length)},updateCommand:function(b){if(!_.find(this.commands,function(a){return a.stamp===b.stamp})){var c,d=_.findWhere(this.new_commands,{stamp:b.stamp});if(d){if(c=_.indexOf(this.new_commands,d),d.do_not_log||this.commands.push(d),this.new_commands.splice(c,1),"sendMsg"===b.type&&"chat"===b.msg_type)return void q.chat_commands.push(b)}else{if(d=_.findWhere(this.replay_commands,{stamp:b.stamp}))return d.redo(this),c=_.indexOf(this.replay_commands,d),this.commands.push(d),void this.replay_commands.splice(c,1);if("sendMsg"===b.type&&"chat"===b.msg_type)return q.chat_commands.push(b),void a.$broadcast("game_chat",b);b.redo(this),b.do_not_log||this.commands.push(b)}}},rollDie:function(a){var b=a||6,c=Math.random(),d=c*b+1;return d>>0},rollDice:function(a,b){var c=[];_.times(a,function(){c.push(q.rollDie(b))});var d=_.reduce(c,function(a,b){return a+b},0),e="d"+(b||6)+JSON.stringify(c)+" = "+d;this.newCommand(g("sendMsg","dice",e))},rollDeviation:function(a){var b=q.rollDie(),c=Math.min(q.rollDie(),a?a:6),d="AoE deviation : direction "+b+", distance "+c+'"';return this.newCommand(g("sendMsg","dice",d)),{direction:b,distance:10*c}},layers:{board:!0,terrain:!0,deployment:!1,scenario:!0,models:!0,templates:!0,view_controls:!0},board:{info:null,window:{width:800,height:800},width:480,height:480,zoom:{factor:1,cx:0,cy:0,flipped:!1},refreshZoom:function(){var a=document.getElementById("canvas-container");this.zoom.cx=(a.scrollLeft+this.window.width/2)/this.zoom.factor,this.zoom.cy=(a.scrollTop+this.window.height/2)/this.zoom.factor},refreshView:function(){var a=this.zoom,b=this.window;window.setTimeout(function(){var c=document.getElementById("canvas-container");c.scrollLeft=a.cx*a.factor-b.width/2,c.scrollTop=a.cy*a.factor-b.height/2},0)},reset:function(){this.zoom.factor=1},zoomIn:function(){this.refreshZoom(),this.zoom.factor*=1.5,this.refreshView()},zoomOut:function(){this.refreshZoom(),this.zoom.factor=Math.max(1,this.zoom.factor/1.5),this.refreshView()},moveLeft:function(){var a=document.getElementById("canvas-container");a.scrollLeft=a.scrollLeft-50},moveUp:function(){var a=document.getElementById("canvas-container");a.scrollTop=a.scrollTop-50},moveRight:function(){var a=document.getElementById("canvas-container");a.scrollLeft=a.scrollLeft+50},moveDown:function(){var a=document.getElementById("canvas-container");a.scrollTop=a.scrollTop+50}},ruler:{state:{x1:0,y1:0,x2:100,y2:100,length:90,range:0,active:!1},origin:null,target:null,cmd:void 0,sendStateCmd:function(){this.cmd||(this.cmd=g("setRuler",this.state)),q.newCommand(this.cmd),this.cmd=void 0},setActive:function(a){if(this.state.active!=a){var b=this.state.active;this.cmd||(this.cmd=g("setRuler",this.state)),this.state.active=a,"draging"!==b||a?q.newCommand(this.cmd):this.cmd.undo(q)}this.cmd=void 0},startDraging:function(a,b){this.cmd=g("setRuler",this.state),this.setStart(a,b),this.state.active=!0},endDraging:function(a,b){this.setEnd(a,b),this.refresh(),this.sendStateCmd()},setStart:function(a,b){this.state.length="",this.state.x1=a,this.state.y1=b,this.state.x2=a,this.state.y2=b},setEnd:function(a,b){this.state.x2=a,this.state.y2=b},refresh:function(){var a=this.state.x2-this.state.x1,b=this.state.y2-this.state.y1;this.state.length=Math.sqrt(a*a+b*b),this.state.length=(10*this.state.length+.5>>0)/100}},los:{state:{x1:0,y1:0,x2:100,y2:100,active:!1},setActive:function(a){this.state.active=a,this.state.model_active=a},startDraging:function(a,b){this.setStart(a,b),this.state.active=!0},endDraging:function(a,b){this.setEnd(a,b)},setStart:function(a,b){this.state.x1=a,this.state.y1=b,this.state.x2=a,this.state.y2=b},setEnd:function(a,b){this.state.x2=a,this.state.y2=b},setOrigin:function(a){this.state.origin=a.state.id,delete this.state.target},setTarget:function(a){if(this.state.target=a.state.id,this.state.origin){var b=q.models[this.state.origin].state.x,c=q.models[this.state.origin].state.y,d=q.models[this.state.origin].info.r,e=q.models[this.state.target].state.x,f=q.models[this.state.target].state.y,g=q.models[this.state.target].info.r,h=e-b,i=f-c,j=Math.atan2(h,-i),k=Math.sqrt(h*h+i*i),l=Math.abs(d-g),m=Math.asin(l/k)*(d>=g?1:-1);this.state.ot1_x1=b+Math.sin(j+Math.PI/2-m)*d,this.state.ot1_y1=c-Math.cos(j+Math.PI/2-m)*d,this.state.ot1_x2=e+Math.sin(j+Math.PI/2-m)*g,this.state.ot1_y2=f-Math.cos(j+Math.PI/2-m)*g,this.state.ot2_x1=b+Math.sin(j-Math.PI/2+m)*d,this.state.ot2_y1=c-Math.cos(j-Math.PI/2+m)*d,this.state.ot2_x2=e+Math.sin(j-Math.PI/2+m)*g,this.state.ot2_y2=f-Math.cos(j-Math.PI/2+m)*g;var n=this.state.ot1_x2-this.state.ot1_x1,o=this.state.ot1_y2-this.state.ot1_y1,p=Math.sqrt(n*n+o*o),r=n/p,s=o/p,t=this.state.ot2_x2-this.state.ot2_x1,u=this.state.ot2_y2-this.state.ot2_y1,v=Math.sqrt(t*t+u*u),w=t/v,x=u/v;this.state.intervs=_.filter(q.models,function(a){if(q.los.state.target===a.state.id||q.los.state.origin===a.state.id||g>a.info.r)return!1;var b=a.state.x-q.los.state.ot1_x1,c=a.state.y-q.los.state.ot1_y1,d=s*b-r*c,e=r*b+s*c,f=d+a.info.r>=0&&e+a.info.r>=0&&e-a.info.r<=p;b=a.state.x-q.los.state.ot2_x1,c=a.state.y-q.los.state.ot2_y1,d=x*b-w*c,e=w*b+x*c;var h=d-a.info.r<=0&&e+a.info.r>=0&&e-a.info.r<=v;return f&&h}).map(function(a){return a.state.id}),this.computeLos()}},toggleInterveningModel:function(a){_.find(this.state.intervs,function(b){return b===a.state.id})?this.state.intervs=_.without(this.state.intervs,a.state.id):this.state.intervs.push(a.state.id),this.computeLos()},computeLos:function(){var a=q.models[this.state.origin].state.x,b=q.models[this.state.origin].state.y,c=q.models[this.state.origin].info.r,d=q.models[this.state.target].state.x,e=q.models[this.state.target].state.y,f=q.models[this.state.target].info.r,g=d-a,h=e-b,i=Math.atan2(g,-h),j=Math.sqrt(g*g+h*h),k=Math.abs(c-f),l=Math.asin(k/j)*(c>=f?1:-1);q.los.state.darkness=q.los.state.darkness||[],q.los.state.darkness.length=0,q.los.state.shadows=q.los.state.shadows||[],q.los.state.shadows.length=0,_.each(this.state.intervs,function(m){function n(a){var b=q.models[a];if(b&&p.state.id!==b.state.id){var c=b.state.x-r,d=b.state.y-t,e=z*c-y*d,f=y*c+z*d;Y=Y||Math.abs(e)<b.info.r&&f+b.info.r>=0&&f-b.info.r<=x}}function o(a){var b=q.models[a];if(b&&p.state.id!==b.state.id){var c=b.state.x-A,d=b.state.y-B,e=I*c-H*d,f=H*c+I*d;Y=Y||Math.abs(e)<b.info.r&&f+b.info.r>=0&&f-b.info.r<=G}}var p=q.models[m];if(p){d=p.state.x,e=p.state.y,f=p.info.r,g=d-a,h=e-b,i=Math.atan2(g,-h),j=Math.sqrt(g*g+h*h),k=Math.abs(c-f),l=Math.asin(k/j)*(c>=f?1:-1);var r,s,t,u,v,w,x,y,z;r=a+Math.sin(i+Math.PI/2-l)*c,t=b-Math.cos(i+Math.PI/2-l)*c,s=d+Math.sin(i+Math.PI/2-l)*f,u=e-Math.cos(i+Math.PI/2-l)*f,v=s-r,w=u-t,x=Math.sqrt(v*v+w*w),y=v/x,z=w/x;var A,B,C,D,E,F,G,H,I;A=a+Math.sin(i-Math.PI/2+l)*c,B=b-Math.cos(i-Math.PI/2+l)*c,C=d+Math.sin(i-Math.PI/2+l)*f,D=e-Math.cos(i-Math.PI/2+l)*f,E=C-A,F=D-B,G=Math.sqrt(E*E+F*F),H=E/G,I=F/G;var J,K,L,M,N,O,P,Q,R,S,T,U,V,W=H*z-I*y;0>W?(N=C-s,O=D-u,P=Math.sqrt(N*N+O*O),Q=N/P,R=O/P,S=Math.acos(Q*y+R*z),T=Math.acos(-Q*H-R*I),U=P*Math.sin(S)/Math.sin(S+T),V=P*Math.sin(T)/Math.sin(S+T),U=Math.min(800,U),V=Math.min(800,V),J=s+y*V,K=u+z*V,L=C+H*U,M=D+I*U):(J=s+800*y,K=u+800*z,L=C+800*H,M=D+800*I),q.los.state.darkness.push({x1:s,y1:u,x2:J,y2:K,x3:L,y3:M,x4:C,y4:D});var X,Y,Z,$,ab,bb,cb,db=i-Math.PI/2+l,eb=i+Math.PI/2-l,fb=(eb-db)/180;for(X=eb;X>db&&(r=a+Math.sin(X)*c,t=b-Math.cos(X)*c,ab=p.state.x-r,bb=p.state.y-t,cb=Math.sqrt(ab*ab+bb*bb),Z=Math.atan2(ab,-bb),$=Math.acos(f/cb),s=d+Math.sin(Z+Math.PI-$)*f,u=e-Math.cos(Z+Math.PI-$)*f,v=s-r,w=u-t,x=Math.sqrt(v*v+w*w),y=v/x,z=w/x,Y=!1,_.each(q.los.state.intervs,n),Y);X-=fb);for(X=db;eb>X&&(A=a+Math.sin(X)*c,B=b-Math.cos(X)*c,ab=p.state.x-A,bb=p.state.y-B,cb=Math.sqrt(ab*ab+bb*bb),Z=Math.atan2(ab,-bb),$=Math.acos(f/cb),C=d+Math.sin(Z-Math.PI+$)*f,D=e-Math.cos(Z-Math.PI+$)*f,E=C-A,F=D-B,G=Math.sqrt(E*E+F*F),H=E/G,I=F/G,Y=!1,_.each(q.los.state.intervs,o),Y);X+=fb);W=H*z-I*y,0>W?(N=C-s,O=D-u,P=Math.sqrt(N*N+O*O),Q=N/P,R=O/P,S=Math.acos(Q*y+R*z),T=Math.acos(-Q*H-R*I),U=P*Math.sin(S)/Math.sin(S+T),V=P*Math.sin(T)/Math.sin(S+T),U=Math.min(800,U),V=Math.min(800,V),J=s+y*V,K=u+z*V,L=C+H*U,M=D+I*U):(J=s+800*y,K=u+800*z,L=C+800*H,M=D+800*I),q.los.state.shadows.push({x1:s,y1:u,x2:J,y2:K,x3:L,y3:M,x4:C,y4:D})}}),this.state.model_active=!0}},save_url:null,generateBackup:function(){var a=this.save_url;this.save_url=null,null!==a&&c.URL.revokeObjectURL(a);var b=_.deepCopy(this);b.clock=i(JSON.parse(JSON.stringify(b.clock))),b.clock.stop();var d=JSON.stringify(b),e=new c.Blob([d],{type:"text/plain"}),f=c.URL.createObjectURL(e),g=Date.now();this.save_name="game_"+g+".txt",this.save_url=f}};_.deepExtend(q,o),q.clock=i(q.clock),_.each(q.models,function(a){e(a)}),q.replay_commands=_.map(q.replay_commands,function(a){return g(a)});var r=q.commands;return q.commands=[],_.each(r,function(a){q.updateCommand(g(a))}),p(),q};return o}]),angular.module("vassalApp.services").factory("games",["$http","$rootScope","user",function(a,b,c){function d(){var a=e;c.wall&&(a+="?close=true"),f.source=new EventSource(a),f.source.onmessage=function(a){var c=JSON.parse(a.data);f.list=c,b.$digest()},f.source.onerror=function(a){return a.target.readyState===a.target.CLOSED?(f.list=[],window.setTimeout(d,5e3),void b.$digest()):(f.source.close(),void d())}}var e="/api/games/subscribe",f={list:[]};return d(),f}]),angular.module("vassalApp.services").factory("model",[function(){var a={resetShow:function(){this.state.show_image=!0,delete this.state.show_melee,delete this.state.show_reach,delete this.state.show_strike,delete this.state.show_aoe,delete this.state.show_area,delete this.state.show_unit,delete this.state.show_control},refresh:function(a){var b,c;if(this.state.show_charge&&(b=this.state.x-this.state.charge_x,c=this.state.y-this.state.charge_y,this.state.charge_length=Math.sqrt(b*b+c*c),this.state.charge_max&&this.state.charge_max>0&&this.state.charge_length>10*this.state.charge_max&&(b=b*this.state.charge_max*10/this.state.charge_length,c=c*this.state.charge_max*10/this.state.charge_length,this.state.x=this.state.charge_x+b,this.state.y=this.state.charge_y+c,this.state.charge_length=10*this.state.charge_max)),this.state.show_place&&(b=this.state.x-this.state.place_x,c=this.state.y-this.state.place_y,this.state.place_length=Math.sqrt(b*b+c*c),this.state.place_max&&this.state.place_max>0)){var d=10*this.state.place_max+(this.state.place_within?2*this.info.r:0);this.state.place_length>d&&(b=b*d/this.state.place_length,c=c*d/this.state.place_length,this.state.x=this.state.place_x+b,this.state.y=this.state.place_y+c,this.state.place_length=d)}this.state.x=Math.max(this.info.r,this.state.x),this.state.x=Math.min(a.board.width-this.info.r,this.state.x),this.state.y=Math.max(this.info.r,this.state.y),this.state.y=Math.min(a.board.height-this.info.r,this.state.y)},alignWith:function(a,b,c){if(!this.info.immovable){var d=180*Math.atan2(b-this.state.x,this.state.y-c)/Math.PI;this.state.rot=d}},moveFront:function(a,b,c){if(!this.info.immovable){var d=b?5:10,e=d*Math.sin(this.state.rot*Math.PI/180),f=-d*Math.cos(this.state.rot*Math.PI/180);this.state.x+=e,this.state.y+=f,this.refresh(a),c&&this.alignWith(a,c.state.x,c.state.y)}},moveBack:function(a,b,c){if(!this.info.immovable){var d=b?5:10,e=-d*Math.sin(this.state.rot*Math.PI/180),f=d*Math.cos(this.state.rot*Math.PI/180);this.state.x+=e,this.state.y+=f,this.refresh(a),c&&this.alignWith(a,c.state.x,c.state.y)}},setRotation:function(a,b){this.info.immovable||(this.state.rot=b)},rotateLeft:function(a,b){if(!this.info.immovable){var c=b?5:10;this.state.rot=this.state.rot-c}},moveLeft:function(a,b){var c,d;if(!this.info.immovable){var e=b?1:10;this.state.x-=e,this.state.show_charge&&(c=this.state.x-this.state.charge_x,d=this.state.y-this.state.charge_y,(Math.abs(c)>0||Math.abs(d)>0)&&(this.state.charge_rot=180*Math.atan2(c,-d)/Math.PI)),this.state.show_place&&(c=this.state.x-this.state.place_x,d=this.state.y-this.state.place_y,(Math.abs(c)>0||Math.abs(d)>0)&&(this.state.place_rot=180*Math.atan2(c,-d)/Math.PI)),this.refresh(a),this.alignWithChargeTarget(a)}},moveUp:function(a,b){var c,d;if(!this.info.immovable){var e=b?1:10;this.state.y-=e,this.state.show_charge&&(c=this.state.x-this.state.charge_x,d=this.state.y-this.state.charge_y,(Math.abs(c)>0||Math.abs(d)>0)&&(this.state.charge_rot=180*Math.atan2(c,-d)/Math.PI)),this.state.show_place&&(c=this.state.x-this.state.place_x,d=this.state.y-this.state.place_y,(Math.abs(c)>0||Math.abs(d)>0)&&(this.state.place_rot=180*Math.atan2(c,-d)/Math.PI)),this.refresh(a),this.alignWithChargeTarget(a)}},rotateRight:function(a,b){if(!this.info.immovable){var c=b?5:10;this.state.rot=this.state.rot+c}},moveRight:function(a,b){var c,d;if(!this.info.immovable){var e=b?1:10;this.state.x+=e,this.state.show_charge&&(c=this.state.x-this.state.charge_x,d=this.state.y-this.state.charge_y,(Math.abs(c)>0||Math.abs(d)>0)&&(this.state.charge_rot=180*Math.atan2(c,-d)/Math.PI)),this.state.show_place&&(c=this.state.x-this.state.place_x,d=this.state.y-this.state.place_y,(Math.abs(c)>0||Math.abs(d)>0)&&(this.state.place_rot=180*Math.atan2(c,-d)/Math.PI)),this.refresh(a),this.alignWithChargeTarget(a)}},moveDown:function(a,b){var c,d;if(!this.info.immovable){var e=b?1:10;this.state.y+=e,this.state.show_charge&&(c=this.state.x-this.state.charge_x,d=this.state.y-this.state.charge_y,(Math.abs(c)>0||Math.abs(d)>0)&&(this.state.charge_rot=180*Math.atan2(c,-d)/Math.PI)),this.state.show_place&&(c=this.state.x-this.state.place_x,d=this.state.y-this.state.place_y,(Math.abs(c)>0||Math.abs(d)>0)&&(this.state.place_rot=180*Math.atan2(c,-d)/Math.PI)),this.refresh(a),this.alignWithChargeTarget(a)}},toggle:function(a,b,c){var d=void 0===c?!this.state["show_"+b]:c;d?this.state["show_"+b]=d:delete this.state["show_"+b]},toggleColor:function(a,b){b?this.state.show_color=b:delete this.state.show_color},toggleAoe:function(a,b){switch(b){case 3:this.state.show_aoe=15===this.state.show_aoe?0:15;break;case 4:this.state.show_aoe=20===this.state.show_aoe?0:20;break;case 5:this.state.show_aoe=25===this.state.show_aoe?0:25}},toggleControl:function(){(this.info.focus||this.info.fury&&"beast"!==this.info.type)&&(this.state.show_control=!this.state.show_control)},setLabel:function(a,b){b=b.trim(),b.length<=0||0<=_.indexOf(this.state.label,b)||this.state.label.push(b)},clearLabel:function(a,b){b>=this.state.label.length||this.state.label.splice(b,1)},clearAllLabel:function(){this.state.label=[]},displayLabel:function(){return _.reduce(this.state.label,function(a,b){return a+" "+b},"")},displayImage:function(){return this.state.show_incorporeal&&this.info.img.incorporeal?this.info.img.incorporeal:this.state.show_leader&&this.info.img.leader?this.info.img.leader:this.state.show_wreck&&this.info.img.wreck?this.info.img.wreck:this.info.img.link},setUnit:function(a,b){this.state.unit=b},incrementCounter:function(){this.state.counter++},decrementCounter:function(){this.state.counter=Math.max(0,this.state.counter-1)},incrementSouls:function(){this.state.souls++},decrementSouls:function(){this.state.souls=Math.max(0,this.state.souls-1)},startCharge:function(a,b){this.setChargeTarget(b),this.state.charge_x=this.state.x,this.state.charge_y=this.state.y,this.state.charge_length=0,this.state.charge_rot=this.state.rot,this.state.show_charge=!0},setChargeTarget:function(a,b){this.state.charge_target=b?b.state.id:null,this.alignWithChargeTarget(a),0===this.state.charge_length&&(this.state.charge_rot=this.state.rot)},alignWithChargeTarget:function(a){this.state.show_charge&&(this.state.charge_target&&a.models[this.state.charge_target]?this.alignWith(a,a.models[this.state.charge_target].state.x,a.models[this.state.charge_target].state.y):this.state.rot=this.state.charge_rot)},moveChargeFront:function(a,b){if(!this.info.immovable){var c=b?5:10,d=c*Math.sin(this.state.charge_rot*Math.PI/180),e=-c*Math.cos(this.state.charge_rot*Math.PI/180);this.state.x+=d,this.state.y+=e,this.refresh(a),this.alignWithChargeTarget(a)}},moveChargeBack:function(a,b){if(!this.info.immovable){var c=b?5:10;if(this.state.charge_length-c<0)this.state.x=this.state.charge_x,this.state.y=this.state.charge_y;else{var d=-c*Math.sin(this.state.charge_rot*Math.PI/180),e=c*Math.cos(this.state.charge_rot*Math.PI/180);this.state.x+=d,this.state.y+=e}this.refresh(a),this.alignWithChargeTarget(a)}},rotateChargeLeft:function(a,b){var c=b?1:5;this.state.charge_rot-=c,this.state.x=this.state.charge_x+Math.sin(this.state.charge_rot*Math.PI/180)*this.state.charge_length,this.state.y=this.state.charge_y-Math.cos(this.state.charge_rot*Math.PI/180)*this.state.charge_length,this.refresh(a),this.alignWithChargeTarget(a)},rotateChargeRight:function(a,b){var c=b?1:5;this.state.charge_rot+=c,this.state.x=this.state.charge_x+Math.sin(this.state.charge_rot*Math.PI/180)*this.state.charge_length,this.state.y=this.state.charge_y-Math.cos(this.state.charge_rot*Math.PI/180)*this.state.charge_length,this.refresh(a),this.alignWithChargeTarget(a)},displayChargeLength:function(){return Math.round(10*this.state.charge_length)/100},chargeTargetInRange:function(a){if(!this.state.charge_target||!a.models[this.state.charge_target])return!1;var b=a.models[this.state.charge_target],c=b.state.x-this.state.x,d=b.state.y-this.state.y,e=Math.sqrt(c*c+d*d)-b.info.r-this.info.r,f=this.state.show_strike?40:this.state.show_reach?20:this.state.show_melee?5:0;return f>=e},endCharge:function(){this.state.charge_length=0,this.state.show_charge=!1},startPlace:function(){this.info.immovable||(this.state.place_x=this.state.x,this.state.place_y=this.state.y,this.state.place_length=0,this.state.place_rot=this.state.rot,this.state.show_place=!0)},setPlaceOrigin:function(a,b){if(!this.info.immovable){var c=this.state.place_x-b.state.x,d=this.state.place_y-b.state.y,e=Math.atan2(c,-d);this.state.place_rot=180*e/Math.PI,this.state.x=this.state.place_x+this.state.place_length*Math.sin(e),this.state.y=this.state.place_y-this.state.place_length*Math.cos(e),this.refresh(a)}},setPlaceTarget:function(a,b){if(!this.info.immovable){var c=b.state.x-this.state.place_x,d=b.state.y-this.state.place_y,e=Math.atan2(c,-d);this.state.place_rot=180*e/Math.PI,this.state.x=this.state.place_x+this.state.place_length*Math.sin(e),this.state.y=this.state.place_y-this.state.place_length*Math.cos(e),this.refresh(a)}},movePlaceFront:function(a,b){if(!this.info.immovable){var c=b?5:10,d=c*Math.sin(this.state.place_rot*Math.PI/180),e=-c*Math.cos(this.state.place_rot*Math.PI/180);this.state.x+=d,this.state.y+=e,this.refresh(a)}},movePlaceBack:function(a,b){if(!this.info.immovable){var c=b?5:10;if(this.state.place_length-c<0)this.state.x=this.state.place_x,this.state.y=this.state.place_y;else{var d=-c*Math.sin(this.state.place_rot*Math.PI/180),e=c*Math.cos(this.state.place_rot*Math.PI/180);this.state.x+=d,this.state.y+=e}this.refresh(a)}},rotatePlaceLeft:function(a,b){var c=b?1:5;this.state.place_rot-=c,this.state.x=this.state.place_x+Math.sin(this.state.place_rot*Math.PI/180)*this.state.place_length,this.state.y=this.state.place_y-Math.cos(this.state.place_rot*Math.PI/180)*this.state.place_length,this.refresh(a)},rotatePlaceRight:function(a,b){var c=b?1:5;this.state.place_rot+=c,this.state.x=this.state.place_x+Math.sin(this.state.place_rot*Math.PI/180)*this.state.place_length,this.state.y=this.state.place_y-Math.cos(this.state.place_rot*Math.PI/180)*this.state.place_length,this.refresh(a)},displayPlaceLength:function(){return Math.round(10*this.state.place_length)/100},deviate:function(a){var b=a.rollDeviation(this.state.place_length/20),c=60*(b.direction-1)+this.state.place_rot,d=+b.distance*Math.sin(c*Math.PI/180),e=-b.distance*Math.cos(c*Math.PI/180);this.state.x+=d,this.state.y+=e,d=this.state.x-this.state.place_x,e=this.state.y-this.state.place_y,this.state.place_rot=180*Math.atan2(d,-e)/Math.PI,this.state.place_max=0,this.refresh(a)},endPlace:function(){this.state.place_length=0,this.state.show_place=!1},startDraging:function(){this.state_before_drag=_.extend({},this.state)},draging:function(a,b,c){this.info.immovable||(this.state.x=this.state_before_drag.x+b,this.state.y=this.state_before_drag.y+c,this.refresh(a))},endDraging:function(a,b,c){this.info.immovable||(this.state.x=this.state_before_drag.x+b,this.state.y=this.state_before_drag.y+c,this.refresh(a))},toggleDamage:function(a,b,c){switch(this.info.damage.type){case"beast":case"gargantuan":case"jack":case"colossal":var d;if("field"===b)return void(this.state.damage.field=this.state.damage.field===c?0:c);
if(void 0===c){var e=this,f=_.reduce(this.info.damage[b],function(a,b){return(b?1:0)+a},0),g=_.reduce(this.state.damage[b],function(a,b){return b+a},0);d=g===f?0:1,_.each(this.state.damage[b],function(a,c){if(e.info.damage[b][c]){var f=e.state.damage[b][c];e.state.damage[b][c]=d,e.state.damage.total+=d-f}});break}if(this.info.damage[b][c]&&this.info.damage[b][c]){var h=this.state.damage[b][c];this.state.damage[b][c]=1===this.state.damage[b][c]?0:1,d=this.state.damage[b][c],this.state.damage.total+=d-h}break;case"warrior":this.state.damage.n=this.state.damage.n===b?0:b,this.state.damage.total=this.state.damage.n}},resetAllDamage:function(){switch(this.info.damage.type){case"jack":case"beast":case"gargantuan":this.state.damage={total:0,1:Array.apply(null,new Array(this.info.damage.depth)).map(Number.prototype.valueOf,0),2:Array.apply(null,new Array(this.info.damage.depth)).map(Number.prototype.valueOf,0),3:Array.apply(null,new Array(this.info.damage.depth)).map(Number.prototype.valueOf,0),4:Array.apply(null,new Array(this.info.damage.depth)).map(Number.prototype.valueOf,0),5:Array.apply(null,new Array(this.info.damage.depth)).map(Number.prototype.valueOf,0),6:Array.apply(null,new Array(this.info.damage.depth)).map(Number.prototype.valueOf,0),field:0};break;case"colossal":this.state.damage={total:0,L1:[0,0,0,0,0,0],L2:[0,0,0,0,0,0],L3:[0,0,0,0,0,0],L4:[0,0,0,0,0,0],L5:[0,0,0,0,0,0],L6:[0,0,0,0,0,0],R1:[0,0,0,0,0,0],R2:[0,0,0,0,0,0],R3:[0,0,0,0,0,0],R4:[0,0,0,0,0,0],R5:[0,0,0,0,0,0],R6:[0,0,0,0,0,0],field:0};break;case"warrior":this.state.damage={total:0,n:0}}},effects:function(){var a=[];return this.state.show_blind&&a.push("B"),this.state.show_corrosion&&a.push("C"),this.state.show_disrupt&&a.push("D"),this.state.show_fire&&a.push("F"),this.state.show_kd&&a.push("K"),this.state.show_stationary&&a.push("S"),a},b2bModels:function(a){var b=this;return _.filter(a.models,function(a){if(a.state.id===b.state.id)return!1;var c=a.state.x-b.state.x,d=a.state.y-b.state.y,e=Math.sqrt(c*c+d*d);return Math.abs(a.info.r+b.info.r-e)<=.2}).map(function(a){return a.state.id})},overlappingModels:function(a){var b=this;return _.filter(a.models,function(a){if(a.state.id===b.state.id)return!1;var c=a.state.x-b.state.x,d=a.state.y-b.state.y,e=Math.sqrt(c*c+d*d);return e-.2<a.info.r+b.info.r}).map(function(a){return a.state.id})},placeB2B:function(a,b){var c=this.state.x-b.state.x,d=this.state.y-b.state.y,e=Math.sqrt(c*c+d*d),f=this.info.r+b.info.r;this.state.x=b.state.x+c*f/e,this.state.y=b.state.y+d*f/e}},b=function(){var b=Array.prototype.slice.call(arguments);if(1===b.length)return _.extend(b[0],a);var c={info:b[1],state:2==b.length?{id:b[0],x:240,y:240,rot:0,counter:"wardude"===b[1].type?b[1].focus?b[1].focus:b[1].fury:0,souls:0,label:[],unit:null,show_image:!0,show_counter:"wardude"===b[1].type||"beast"===b[1].type||"jack"===b[1].type}:_.extend({id:b[0],x:240,y:240,rot:0,counter:"wardude"===b[1].type?b[1].focus?b[1].focus:b[1].fury:0,souls:0,label:[],unit:null,show_image:!0,show_counter:"wardude"===b[1].type||"beast"===b[1].type||"jack"===b[1].type},b[2])};switch(c.info.damage.type){case"jack":case"beast":case"gargantuan":c.state.damage={total:0,1:Array.apply(null,new Array(c.info.damage.depth)).map(Number.prototype.valueOf,0),2:Array.apply(null,new Array(c.info.damage.depth)).map(Number.prototype.valueOf,0),3:Array.apply(null,new Array(c.info.damage.depth)).map(Number.prototype.valueOf,0),4:Array.apply(null,new Array(c.info.damage.depth)).map(Number.prototype.valueOf,0),5:Array.apply(null,new Array(c.info.damage.depth)).map(Number.prototype.valueOf,0),6:Array.apply(null,new Array(c.info.damage.depth)).map(Number.prototype.valueOf,0),field:0};break;case"colossal":c.state.damage={total:0,L1:[0,0,0,0,0,0],L2:[0,0,0,0,0,0],L3:[0,0,0,0,0,0],L4:[0,0,0,0,0,0],L5:[0,0,0,0,0,0],L6:[0,0,0,0,0,0],R1:[0,0,0,0,0,0],R2:[0,0,0,0,0,0],R3:[0,0,0,0,0,0],R4:[0,0,0,0,0,0],R5:[0,0,0,0,0,0],R6:[0,0,0,0,0,0],field:0};break;case"warrior":c.state.damage={total:0,n:0}}return _.extend(c,a),c};return b}]),angular.module("vassalApp.services").factory("modes",["$q","$rootScope","common_mode","default_mode","model_selected_mode","selection_drag_mode","model_charge_mode","model_place_mode","model_place_origin_mode","model_place_target_mode","model_create_mode","model_drag_mode","model_target_mode","template_mode","template_locked_mode","template_create_mode","template_drag_mode","template_origin_mode","template_target_mode","los_mode","los_origin_mode","los_target_mode","los_drag_mode","ruler_mode","ruler_drag_mode","ruler_origin_mode","ruler_target_mode",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A){var B={},C=c(B);return B["default"]=d(B,C),B.model_selected=e(B,C),B.selection_drag=f(B,C),B.model_charge=g(B,C),B.model_place=h(B,C),B.model_place_origin=i(B,C),B.model_place_target=j(B,C),B.model_create=k(B,C),B.model_drag=l(B,C),B.model_target=m(B,C),B.template_locked=o(B,C),B.template=n(B,C),B.template_create=p(B,C),B.template_drag=q(B,C),B.template_origin=r(B,C),B.template_target=s(B,C),B.los=t(B,C),B.los_origin=u(B,C),B.los_target=v(B,C),B.los_drag=w(B,C),B.ruler=x(B,C),B.ruler_drag=y(B,C),B.ruler_origin=z(B,C),B.ruler_target=A(B,C),B.current=B["default"],B.goTo=function(a,c){if(_.has(B,a)){var d=B.current;B.current&&B.current.leave(c,B[a]),B.current=B[a],B.current.enter(c,d),b.$broadcast("mode change")}},B.respondTo=function(a){return _.has(B.current,a)},B.send=function(b){var c=a.defer();if(B.respondTo(b)){var d=B.current[b].apply(B.current,Array.prototype.slice.call(arguments,1));d===!1?c.reject():c.resolve()}else c.reject();return c.promise},B}]),angular.module("vassalApp.services").factory("common_mode",["command",function(){return function(a){var b={name:"Common",enter:function(){},leave:function(){},Escape:function(a){a.modes.goTo("default",a)},"Ctrl Shift F":function(a){a.game.board.zoom.flipped=!a.game.board.zoom.flipped},"Ctrl Z":function(b){b.game.id&&(b.game.undoLastCommand(),a.goTo("default",b))},"Ctrl Shift Z":function(b){b.game.id&&(a.goTo("default",b),b.game.undoAllCommands())},"Ctrl Y":function(b){b.game.id&&(b.game.replayNextCommand(),a.goTo("default",b))},"Ctrl Shift Y":function(b){b.game.id&&(a.goTo("default",b),b.game.replayAllCommands())},"Alt Z":function(a){a.game.board.reset()},"Alt Add":function(a){a.game.board.zoomIn()},"Alt Substract":function(a){a.game.board.zoomOut()},"Alt Left":function(a){a.game.board.moveLeft()},"Alt Down":function(a){a.game.board.moveDown()},"Alt Right":function(a){a.game.board.moveRight()},"Alt Up":function(a){a.game.board.moveUp()}};return b}}]),angular.module("vassalApp.services").factory("default_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"Default",group:"Default",enter:function(a){a.game.templates.active=null,a.game.selection.length>0&&b.goTo("model_selected",a)},"Ctrl A":function(c){var d=_.filter(c.game.models,function(a){return a.state.user===c.user.name}).map(function(a){return a.state.id});c.game.newCommand(a("setSelection",d)),b.goTo("model_selected",c)},"Shift L":function(a){b.goTo("los",a)},"Shift R":function(a){b.goTo("ruler",a)},DragStart:function(c,d,e){if(c.game.id)switch(e.event){case"Template":c.game.templates.active=e.target,e.target.startDraging(),b.goTo("template_drag",c);break;case"Model":if(0>_.indexOf(c.game.selection,e.target.state.id)){if(e.target.state.show_charge)break;c.game.newCommand(a("setSelection",[e.target.state.id])),c.model_view.label=c.game.models[c.game.selection[0]].state.label,c.model_view.unit=c.game.models[c.game.selection[0]].state.unit}c.game.onSelection("startDraging"),b.model_drag.length=0,b.model_drag.start_x=e.target.state.x,b.model_drag.start_y=e.target.state.y,b.model_drag.end_x=e.target.state.x,b.model_drag.end_y=e.target.state.y,b.model_drag.length="",b.goTo("model_drag",c);break;case"Board":b.selection_drag.width=0,b.selection_drag.height=0,b.goTo("selection_drag",c)}},Click:function(c,d,e){switch(e.event){case"Model":if(d.shiftKey&&1===c.game.selection.length)return void c.game.newCommand(a("onSelection","placeB2B",e.target));if(c.game.newCommand(d.ctrlKey||c.force.ctrl?0<=_.indexOf(c.game.selection,e.target.state.id)?a("removeFromSelection",[e.target.state.id]):a("addToSelection",[e.target.state.id]):a("setSelection",[e.target.state.id])),c.model_view.label=null,c.model_view.unit=null,1===c.game.selection.length){if(c.model_view.unit=c.game.models[c.game.selection[0]].state.unit,c.game.models[c.game.selection[0]].state.show_charge){b.goTo("model_charge",c);break}if(c.game.models[c.game.selection[0]].state.show_place){b.goTo("model_place",c);break}}b.goTo("default",c);break;case"Template":c.game.templates.active=e.target,b.goTo("template",c)}}}),d}}]).factory("model_selected_mode",["command",function(a){return function(b){var c=_.deepCopy(b["default"]);return _.deepExtend(c,{name:"Model Selected",group:"Default",template:"model_selected.html",enter:function(a){return a.game.selection.length<=0?void b.goTo("default",a):void 0},Escape:function(b){b.game.newCommand(a("setSelection",[])),b.modes.goTo("default",b)},"Alt B":function(b){if(b.game.id){var c=!b.game.models[b.game.selection[0]].state.show_blind;b.game.newCommand(a("onSelection","toggle","blind",c))}},C:function(c){c.game.id&&1===c.game.selection.length&&(c.game.newCommand(a("onSelection","startCharge")),b.goTo("model_charge",c))},"Alt C":function(b){if(b.game.id){var c=!b.game.models[b.game.selection[0]].state.show_corrosion;b.game.newCommand(a("onSelection","toggle","corrosion",c))}},"Ctrl C":function(a){if(a.game.id){b.model_create.info=[];var c=a.game.models[a.game.selection[0]].state.x,d=a.game.models[a.game.selection[0]].state.y;b.model_create.x=c+10,b.model_create.y=d+10,_.each(a.game.selection,function(e){var f=a.game.models[e].state.x-c,g=a.game.models[e].state.y-d;b.model_create.info.push({info:a.game.models[e].info,offset_x:f,offset_y:g,show_leader:a.game.models[e].state.show_leader,unit:a.game.models[e].state.unit})}),b.goTo("model_create",a)}},"Shift C":function(b){1===b.game.selection.length&&(b.game.models[b.game.selection[0]].info.focus||b.game.models[b.game.selection[0]].info.fury)&&b.game.newCommand(a("onSelection","toggleControl"))},"Alt D":function(b){if(b.game.id){var c=!b.game.models[b.game.selection[0]].state.show_disrupt;b.game.newCommand(a("onSelection","toggle","disrupt",c))}},"Ctrl E":function(b){if(1===b.game.selection.length){var c,d=b.game.models[b.game.selection[0]];if(d.state.show_control&&"wardude"===d.info.type&&(c=20*(d.info.fury||d.info.focus)),c){var e=_.filter(b.game.models,function(a){if(a.state.user===d.state.user)return!1;var b=a.state.x-d.state.x,e=a.state.y-d.state.y,f=Math.sqrt(b*b+e*e);return f<=c+d.info.r+a.info.r}).map(function(a){return a.state.id});b.game.newCommand(a("setSelection",e))}}},"Shift E":function(b){if(1===b.game.selection.length){var c,d=b.game.models[b.game.selection[0]];if(d.state.show_area&&(c=10*d.state.show_area),c){var e=_.filter(b.game.models,function(a){if(a.state.user===d.state.user)return!1;var b=a.state.x-d.state.x,e=a.state.y-d.state.y,f=Math.sqrt(b*b+e*e);return f<=c+d.info.r+a.info.r}).map(function(a){return a.state.id});b.game.newCommand(a("setSelection",e))}}},"Ctrl F":function(b){if(1===b.game.selection.length){var c,d=b.game.models[b.game.selection[0]];if(d.state.show_control&&"wardude"===d.info.type&&(c=20*(d.info.fury||d.info.focus)),c){var e=_.filter(b.game.models,function(a){if(a.state.id===d.state.id)return!0;if(a.state.user!==d.state.user)return!1;var b=a.state.x-d.state.x,e=a.state.y-d.state.y,f=Math.sqrt(b*b+e*e);return f<=c+d.info.r+a.info.r}).map(function(a){return a.state.id});b.game.newCommand(a("setSelection",e))}}},"Shift F":function(b){if(1===b.game.selection.length){var c,d=b.game.models[b.game.selection[0]];if(d.state.show_area&&(c=10*d.state.show_area),c){var e=_.filter(b.game.models,function(a){if(a.state.id===d.state.id)return!0;if(a.state.user!==d.state.user)return!1;var b=a.state.x-d.state.x,e=a.state.y-d.state.y,f=Math.sqrt(b*b+e*e);return f<=c+d.info.r+a.info.r}).map(function(a){return a.state.id});b.game.newCommand(a("setSelection",e))}}},"Alt F":function(b){if(b.game.id){var c=!b.game.models[b.game.selection[0]].state.show_fire;b.game.newCommand(a("onSelection","toggle","fire",c))}},I:function(b){b.game.newCommand(a("onSelection","toggle","image"))},"Alt I":function(b){if(b.game.id){var c=!b.game.models[b.game.selection[0]].state.show_incorporeal;b.game.newCommand(a("onSelection","toggle","incorporeal",c))}},"Alt K":function(b){if(b.game.id){var c=!b.game.models[b.game.selection[0]].state.show_kd;b.game.newCommand(a("onSelection","toggle","kd",c))}},"Alt L":function(b){if(b.game.id){var c=!b.game.models[b.game.selection[0]].state.show_leader;b.game.newCommand(a("onSelection","toggle","leader",c))}},"Ctrl L":function(b){b.game.id&&b.game.newCommand(a("onSelection","clearAllLabel"))},M:function(b){var c=!b.game.models[b.game.selection[0]].state.show_melee;b.game.newCommand(a("onSelection","toggle","melee",c))},N:function(b){var c=!b.game.models[b.game.selection[0]].state.show_counter;b.game.newCommand(a("onSelection","toggle","counter",c))},P:function(c){c.game.id&&1===c.game.selection.length&&(c.game.newCommand(a("onSelection","startPlace")),b.goTo("model_place",c))},R:function(b){var c=!b.game.models[b.game.selection[0]].state.show_reach;b.game.newCommand(a("onSelection","toggle","reach",c))},"Alt R":function(b){b.game.newCommand(a("onSelection","resetShow"))},S:function(b){var c=!b.game.models[b.game.selection[0]].state.show_strike;b.game.newCommand(a("onSelection","toggle","strike",c))},"Alt S":function(b){if(b.game.id){var c=!b.game.models[b.game.selection[0]].state.show_stationary;b.game.newCommand(a("onSelection","toggle","stationary",c))}},"Shift S":function(b){var c=!b.game.models[b.game.selection[0]].state.show_souls;b.game.newCommand(a("onSelection","toggle","souls",c))},T:function(a){a.game.id&&b.goTo("model_target",a)},"Alt T":function(b){if(b.game.id){var c=!b.game.models[b.game.selection[0]].state.show_fleeing;b.game.newCommand(a("onSelection","toggle","fleeing",c))}},U:function(b){var c=!b.game.models[b.game.selection[0]].state.show_unit;b.game.newCommand(a("onSelection","toggle","unit",c))},"Ctrl U":function(b){var c=b.game.models[b.game.selection[0]].state.unit,d=b.game.models[b.game.selection[0]].state.user,e=_.filter(b.game.models,function(a){return a.state.unit===c&&a.state.user===d}).map(function(a){return a.state.id});b.game.newCommand(a("setSelection",e))},"Alt W":function(b){if(b.game.id){var c=!b.game.models[b.game.selection[0]].state.show_wreck;b.game.newCommand(a("onSelection","toggle","wreck",c))}},"Alt 0":function(b){var c=10===b.game.models[b.game.selection[0]].state.show_area?0:10;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 0":function(b){var c=20===b.game.models[b.game.selection[0]].state.show_area?0:20;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt 1":function(b){var c=1===b.game.models[b.game.selection[0]].state.show_area?0:1;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 1":function(b){var c=11===b.game.models[b.game.selection[0]].state.show_area?0:11;b.game.newCommand(a("onSelection","toggle","area",c))},"Ctrl 1":function(b){if(b.game.id){var c="#0FF"===b.game.models[b.game.selection[0]].state.show_color?!1:"#0FF";b.game.newCommand(a("onSelection","toggleColor",c))}},"Alt 2":function(b){var c=2===b.game.models[b.game.selection[0]].state.show_area?0:2;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 2":function(b){var c=12===b.game.models[b.game.selection[0]].state.show_area?0:12;b.game.newCommand(a("onSelection","toggle","area",c))},"Ctrl 2":function(b){if(b.game.id){var c="#F0F"===b.game.models[b.game.selection[0]].state.show_color?!1:"#F0F";b.game.newCommand(a("onSelection","toggleColor",c))}},3:function(b){b.game.newCommand(a("onSelection","toggleAoe",3))},"Alt 3":function(b){var c=3===b.game.models[b.game.selection[0]].state.show_area?0:3;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 3":function(b){var c=13===b.game.models[b.game.selection[0]].state.show_area?0:13;b.game.newCommand(a("onSelection","toggle","area",c))},"Ctrl 3":function(b){if(b.game.id){var c="#FF0"===b.game.models[b.game.selection[0]].state.show_color?!1:"#FF0";b.game.newCommand(a("onSelection","toggleColor",c))}},4:function(b){b.game.newCommand(a("onSelection","toggleAoe",4))},"Alt 4":function(b){var c=4===b.game.models[b.game.selection[0]].state.show_area?0:4;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 4":function(b){var c=14===b.game.models[b.game.selection[0]].state.show_area?0:14;b.game.newCommand(a("onSelection","toggle","area",c))},"Ctrl 4":function(b){if(b.game.id){var c="#00F"===b.game.models[b.game.selection[0]].state.show_color?!1:"#00F";b.game.newCommand(a("onSelection","toggleColor",c))}},5:function(b){b.game.newCommand(a("onSelection","toggleAoe",5))},"Alt 5":function(b){var c=5===b.game.models[b.game.selection[0]].state.show_area?0:5;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 5":function(b){var c=15===b.game.models[b.game.selection[0]].state.show_area?0:15;b.game.newCommand(a("onSelection","toggle","area",c))},"Ctrl 5":function(b){if(b.game.id){var c="#0F0"===b.game.models[b.game.selection[0]].state.show_color?!1:"#0F0";b.game.newCommand(a("onSelection","toggleColor",c))}},"Alt 6":function(b){var c=6===b.game.models[b.game.selection[0]].state.show_area?0:6;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 6":function(b){var c=16===b.game.models[b.game.selection[0]].state.show_area?0:16;b.game.newCommand(a("onSelection","toggle","area",c))},"Ctrl 6":function(b){if(b.game.id){var c="#F00"===b.game.models[b.game.selection[0]].state.show_color?!1:"#F00";b.game.newCommand(a("onSelection","toggleColor",c))}},"Alt 7":function(b){var c=7===b.game.models[b.game.selection[0]].state.show_area?0:7;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 7":function(b){var c=17===b.game.models[b.game.selection[0]].state.show_area?0:17;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt 8":function(b){var c=8===b.game.models[b.game.selection[0]].state.show_area?0:8;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 8":function(b){var c=18===b.game.models[b.game.selection[0]].state.show_area?0:18;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt 9":function(b){var c=9===b.game.models[b.game.selection[0]].state.show_area?0:9;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 9":function(b){var c=19===b.game.models[b.game.selection[0]].state.show_area?0:19;b.game.newCommand(a("onSelection","toggle","area",c))},Delete:function(c){c.game.id&&(c.game.newCommand(a("dropSelection")),b.goTo("default",c))},"Ctrl D":function(a){this.Delete(a)},Add:function(b){b.game.id&&b.game.newCommand(a("onSelection","incrementCounter"))},"Ctrl Add":function(b){if(b.game.id&&1===b.game.selection.length){var c=b.game.models[b.game.selection[0]];if("warrior"===c.info.damage.type){var d=c.state.damage.n,e=Math.min(d+1,c.info.damage.n);e!==d&&b.game.newCommand(a("onSelection","toggleDamage",e))}}},"Shift Add":function(b){b.game.id&&b.game.newCommand(a("onSelection","incrementSouls"))},Substract:function(b){b.game.id&&b.game.newCommand(a("onSelection","decrementCounter"))},"Ctrl Substract":function(b){if(b.game.id&&1===b.game.selection.length){var c=b.game.models[b.game.selection[0]];if("warrior"===c.info.damage.type){var d=c.state.damage.n,e=Math.max(d-1,0);e!==d&&b.game.newCommand(a("onSelection","toggleDamage",e))}}},"Shift Substract":function(b){b.game.id&&b.game.newCommand(a("onSelection","decrementSouls"))},PageUp:function(b){b.game.id&&b.game.newCommand(a("onSelection","setRotation",b.game.board.zoom.flipped?180:0))},PageDown:function(b){b.game.id&&b.game.newCommand(a("onSelection","setRotation",b.game.board.zoom.flipped?0:180))},Left:function(b){b.game.id&&b.game.newCommand(a("onSelection","rotateLeft",!1))},"Shift Left":function(b){b.game.id&&b.game.newCommand(a("onSelection","rotateLeft",!0))},"Ctrl Left":function(b){b.game.id&&b.game.newCommand(a("onSelection",b.game.board.zoom.flipped?"moveRight":"moveLeft",!0))},Down:function(b){b.game.id&&b.game.newCommand(a("onSelection","moveBack",!1))},"Shift Down":function(b){b.game.id&&b.game.newCommand(a("onSelection","moveBack",!0))},"Ctrl Down":function(b){b.game.id&&b.game.newCommand(a("onSelection",b.game.board.zoom.flipped?"moveUp":"moveDown",!0))},Right:function(b){b.game.id&&b.game.newCommand(a("onSelection","rotateRight",!1))},"Shift Right":function(b){b.game.id&&b.game.newCommand(a("onSelection","rotateRight",!0))},"Ctrl Right":function(b){b.game.id&&b.game.newCommand(a("onSelection",b.game.board.zoom.flipped?"moveLeft":"moveRight",!0))},Up:function(b){b.game.id&&b.game.newCommand(a("onSelection","moveFront",!1))},"Shift Up":function(b){b.game.id&&b.game.newCommand(a("onSelection","moveFront",!0))},"Ctrl Up":function(b){b.game.id&&b.game.newCommand(a("onSelection",b.game.board.zoom.flipped?"moveDown":"moveUp",!0))}}),c}}]),angular.module("vassalApp.services").factory("los_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"LoS",group:"LoS",template:"los.html",leave:function(b,c){"LoS"!==c.group&&b.game.newCommand(a("onLos","setActive",!1))},O:function(a){b.goTo("los_origin",a)},T:function(a){b.goTo("los_target",a)},"Shift L":function(a){b.goTo("default",a)},DragStart:function(a,c,d){a.game.los.startDraging(d.start_x,d.start_y),b.goTo("los_drag",a)},Click:function(b,c,d){switch(d.event){case"Model":if(c.ctrlKey)return b.game.newCommand(a("onLos","setOrigin",d.target)),!0;if(c.shiftKey)return b.game.newCommand(a("onLos","setTarget",d.target)),!0;if(b.game.los.state.origin&&b.game.los.state.target)return b.game.newCommand(a("onLos","toggleInterveningModel",d.target)),!0}return!1}}),d}}]).factory("los_origin_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"LoS Origin",group:"LoS",template:"los_origin.html",Click:function(c,d,e){return"Model"===e.event?(c.game.newCommand(a("onLos","setOrigin",e.target)),b.goTo("los",c),!0):!1}}),d}}]).factory("los_target_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"LoS Target",group:"LoS",template:"los_target.html",Click:function(c,d,e){return"Model"===e.event?(c.game.newCommand(a("onLos","setTarget",e.target)),b.goTo("los",c),!0):!1}}),d}}]).factory("los_drag_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"LoS Drag",group:"LoS",template:"los.html",Drag:function(a,b,c,d,e){a.game.los.setEnd(d,e)},DragEnd:function(c,d,e,f,g){c.game.newCommand(a("onLos","endDraging",f,g)),b.goTo("los",c)}}),d}}]),angular.module("vassalApp.services").factory("model_place_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"Model Place",group:"Model Place",template:"model_place.html",enter:function(){},leave:function(b,c){"Model Place"!==c.group&&b.game.newCommand(a("onSelection","endPlace"))},D:function(b){b.game.id&&b.game.newCommand(a("onSelection","deviate"))},I:function(b){b.game.newCommand(a("onSelection","toggle","image"))},M:function(b){var c=!b.game.models[b.game.selection[0]].state.show_melee;b.game.newCommand(a("onSelection","toggle","melee",c))},O:function(a){b.goTo("model_place_origin",a)},P:function(a){b.goTo("default",a)},R:function(b){var c=!b.game.models[b.game.selection[0]].state.show_reach;b.game.newCommand(a("onSelection","toggle","reach",c))},"Alt R":function(b){b.game.newCommand(a("onSelection","resetShow"))},S:function(b){var c=!b.game.models[b.game.selection[0]].state.show_strike;b.game.newCommand(a("onSelection","toggle","strike",c))},T:function(a){b.goTo("model_place_target",a)},Left:function(b){b.game.id&&b.game.newCommand(a("onSelection","rotatePlaceLeft",!1))},"Shift Left":function(b){b.game.id&&b.game.newCommand(a("onSelection","rotatePlaceLeft",!0))},"Ctrl Left":function(b){b.game.id&&b.game.newCommand(a("onSelection",b.game.board.zoom.flipped?"moveRight":"moveLeft",!0))},Down:function(b){b.game.id&&b.game.newCommand(a("onSelection","movePlaceBack",!1))},"Shift Down":function(b){b.game.id&&b.game.newCommand(a("onSelection","movePlaceBack",!0))},"Ctrl Down":function(b){b.game.id&&b.game.newCommand(a("onSelection",b.game.board.zoom.flipped?"moveUp":"moveDown",!0))},Right:function(b){b.game.id&&b.game.newCommand(a("onSelection","rotatePlaceRight",!1))},"Shift Right":function(b){b.game.id&&b.game.newCommand(a("onSelection","rotatePlaceRight",!0))},"Ctrl Right":function(b){b.game.id&&b.game.newCommand(a("onSelection",b.game.board.zoom.flipped?"moveLeft":"moveRight",!0))},Up:function(b){b.game.id&&b.game.newCommand(a("onSelection","movePlaceFront",!1))},"Shift Up":function(b){b.game.id&&b.game.newCommand(a("onSelection","movePlaceFront",!0))},"Ctrl Up":function(b){b.game.id&&b.game.newCommand(a("onSelection",b.game.board.zoom.flipped?"moveDown":"moveUp",!0))},Click:function(b,c,d){if("Model"===d.event&&d.target.state.id!==b.game.selection[0]){if(c.ctrlKey)return b.game.newCommand(a("onSelection","setPlaceOrigin",d.target)),!0;if(c.shiftKey)return b.game.newCommand(a("onSelection","setPlaceTarget",d.target)),!0}return!1}}),d}}]).factory("model_place_origin_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"Model Place Origin",group:"Model Place",template:"model_place_origin.html",enter:function(){},leave:function(b,c){"Model Place"!==c.group&&b.game.newCommand(a("onSelection","endPlace"))},P:function(a){b.goTo("model_place",a)},Click:function(c,d,e){return"Model"===e.event&&e.target.state.id!==c.game.selection[0]?(c.game.newCommand(a("onSelection","setPlaceOrigin",e.target)),b.goTo("model_place",c),!0):!1}}),d}}]).factory("model_place_target_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"Model Place Target",group:"Model Place",template:"model_place_target.html",enter:function(){},leave:function(b,c){"Model Place"!==c.group&&b.game.newCommand(a("onSelection","endPlace"))},P:function(a){b.goTo("model_place",a)},Click:function(c,d,e){return"Model"===e.event&&e.target.state.id!==c.game.selection[0]?(c.game.newCommand(a("onSelection","setPlaceTarget",e.target)),b.goTo("model_place",c),!0):!1}}),d}}]).factory("model_charge_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"Model Charge",template:"model_charge.html",enter:function(){},leave:function(b){b.game.newCommand(a("onSelection","endCharge"))},C:function(a){b.goTo("default",a)},"Shift C":function(b){1===b.game.selection.length&&(b.game.models[b.game.selection[0]].info.focus||b.game.models[b.game.selection[0]].info.fury)&&b.game.newCommand(a("onSelection","toggleControl"))},I:function(b){b.game.newCommand(a("onSelection","toggle","image"))},M:function(b){var c=!b.game.models[b.game.selection[0]].state.show_melee;b.game.newCommand(a("onSelection","toggle","melee",c))},R:function(b){var c=!b.game.models[b.game.selection[0]].state.show_reach;b.game.newCommand(a("onSelection","toggle","reach",c))},"Alt R":function(b){b.game.newCommand(a("onSelection","resetShow"))},S:function(b){var c=!b.game.models[b.game.selection[0]].state.show_strike;b.game.newCommand(a("onSelection","toggle","strike",c))},"Alt 0":function(b){var c=10===b.game.models[b.game.selection[0]].state.show_area?0:10;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 0":function(b){var c=20===b.game.models[b.game.selection[0]].state.show_area?0:20;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt 1":function(b){var c=1===b.game.models[b.game.selection[0]].state.show_area?0:1;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 1":function(b){var c=11===b.game.models[b.game.selection[0]].state.show_area?0:11;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt 2":function(b){var c=2===b.game.models[b.game.selection[0]].state.show_area?0:2;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 2":function(b){var c=12===b.game.models[b.game.selection[0]].state.show_area?0:12;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt 3":function(b){var c=3===b.game.models[b.game.selection[0]].state.show_area?0:3;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 3":function(b){var c=13===b.game.models[b.game.selection[0]].state.show_area?0:13;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt 4":function(b){var c=4===b.game.models[b.game.selection[0]].state.show_area?0:4;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 4":function(b){var c=14===b.game.models[b.game.selection[0]].state.show_area?0:14;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt 5":function(b){var c=5===b.game.models[b.game.selection[0]].state.show_area?0:5;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 5":function(b){var c=15===b.game.models[b.game.selection[0]].state.show_area?0:15;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt 6":function(b){var c=6===b.game.models[b.game.selection[0]].state.show_area?0:6;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 6":function(b){var c=16===b.game.models[b.game.selection[0]].state.show_area?0:16;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt 7":function(b){var c=7===b.game.models[b.game.selection[0]].state.show_area?0:7;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 7":function(b){var c=17===b.game.models[b.game.selection[0]].state.show_area?0:17;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt 8":function(b){var c=8===b.game.models[b.game.selection[0]].state.show_area?0:8;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 8":function(b){var c=18===b.game.models[b.game.selection[0]].state.show_area?0:18;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt 9":function(b){var c=9===b.game.models[b.game.selection[0]].state.show_area?0:9;b.game.newCommand(a("onSelection","toggle","area",c))},"Alt Shift 9":function(b){var c=19===b.game.models[b.game.selection[0]].state.show_area?0:19;b.game.newCommand(a("onSelection","toggle","area",c))},Left:function(b){b.game.id&&b.game.newCommand(a("onSelection","rotateChargeLeft",!1))},"Shift Left":function(b){b.game.id&&b.game.newCommand(a("onSelection","rotateChargeLeft",!0))},"Ctrl Left":function(b){b.game.id&&b.game.newCommand(a("onSelection",b.game.board.zoom.flipped?"moveRight":"moveLeft",!0))},Down:function(b){b.game.id&&b.game.newCommand(a("onSelection","moveChargeBack",!1))},"Shift Down":function(b){b.game.id&&b.game.newCommand(a("onSelection","moveChargeBack",!0))},"Ctrl Down":function(b){b.game.id&&b.game.newCommand(a("onSelection",b.game.board.zoom.flipped?"moveUp":"moveDown",!0))},Right:function(b){b.game.id&&b.game.newCommand(a("onSelection","rotateChargeRight",!1))},"Shift Right":function(b){b.game.id&&b.game.newCommand(a("onSelection","rotateChargeRight",!0))},"Ctrl Right":function(b){b.game.id&&b.game.newCommand(a("onSelection",b.game.board.zoom.flipped?"moveLeft":"moveRight",!0))},Up:function(b){b.game.id&&b.game.newCommand(a("onSelection","moveChargeFront",!1))},"Shift Up":function(b){b.game.id&&b.game.newCommand(a("onSelection","moveChargeFront",!0))},"Ctrl Up":function(b){b.game.id&&b.game.newCommand(a("onSelection",b.game.board.zoom.flipped?"moveDown":"moveUp",!0))},Click:function(b,c,d){return c.shiftKey&&"Model"===d.event&&d.target.state.id!==b.game.selection[0]?(b.game.newCommand(a("onSelection","setChargeTarget",d.target)),!0):!1}}),d}}]).factory("model_create_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"Model Create",template:"model_create.html",MouseMove:function(a,b,c,e){a.game.id&&(d.x=c,d.y=e)
},Click:function(c,e,f,g,h){if(c.game.id){var i=[];_.each(d.info,function(a){var b=_.omit(a,"offset_x","offset_y");i.push(_.extend(b,{x:g+a.offset_x,y:h+a.offset_y,user:c.user.name}))}),c.game.newCommand(a("createModel",i)),b.goTo("default",c)}}}),d}}]).factory("model_drag_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"Model Drag",template:"model_selected.html",Drag:function(a,b,c,d,e,f,g){a.game.id&&(a.game.onSelection("draging",f,g),this.end_x=this.start_x+f,this.end_y=this.start_y+g,this.length=(10*Math.sqrt(f*f+g*g)>>0)/100)},DragEnd:function(c,d,e,f,g,h,i){c.game.id&&(c.game.newCommand(a("endDragingSelection",h,i)),b.goTo("default",c))}}),d}}]).factory("model_target_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"Model Target",template:"model_target.html",Click:function(c,d,e){return c.game.id?"Model"===e.event&&0>_.indexOf(c.game.selection,e.target.state.id)?(c.game.newCommand(a("onSelection","alignWith",e.target.state.x,e.target.state.y)),b.goTo("default",c),!0):!1:void 0}}),d}}]),angular.module("vassalApp.services").factory("ruler_mode",["command",function(){return function(a,b){var c=_.deepCopy(b);return _.deepExtend(c,{name:"Ruler",group:"Ruler",template:"ruler.html",enter:function(a,b){"Ruler"!==b.group&&(a.game.ruler.state.origin=null,a.game.ruler.state.target=null),a.game.ruler.sendStateCmd()},O:function(b){a.goTo("ruler_origin",b)},"Shift R":function(b){a.goTo("default",b)},T:function(b){a.goTo("ruler_target",b)},DragStart:function(b,c,d){b.game.ruler.startDraging(d.start_x,d.start_y),b.show_ruler=!0,a.goTo("ruler_drag",b)},Click:function(a,b,c){switch(c.event){case"Model":var d=c.target;if(b.ctrlKey)return a.game.ruler.state.origin=d.state.id,a.game.ruler.setStart(d.state.x,d.state.y),a.game.ruler.state.active=!1,a.game.ruler.state.target=null,a.game.ruler.sendStateCmd(),!0;if(b.shiftKey){if(a.game.ruler.state.origin===d.state.id)return!0;a.game.ruler.state.target=d.state.id;var e,f=a.game.ruler,g=f.state.x1,h=f.state.y1,i=d.state.x,j=d.state.y;a.game.ruler.state.origin&&(e=a.game.models[a.game.ruler.state.origin],g=e.state.x,h=e.state.y);var k=Math.atan2(i-g,h-j);e&&(g+=e.info.r*Math.sin(k),h-=e.info.r*Math.cos(k)),i-=d.info.r*Math.sin(k),j+=d.info.r*Math.cos(k);var l=i-g,m=j-h,n=Math.sqrt(l*l+m*m),o=n;return a.game.ruler.state.target_in_range=!0,a.game.ruler.state.range>0&&(a.game.ruler.state.target_in_range=o<=10*a.game.ruler.state.range,o=Math.min(10*a.game.ruler.state.range,n)),i=g+(i-g)*o/n,j=h+(j-h)*o/n,a.game.ruler.setStart(g,h),a.game.ruler.setEnd(i,j),a.game.ruler.refresh(),a.game.ruler.state.active=!0,a.game.ruler.sendStateCmd(),!0}}return!1}}),c}}]).factory("ruler_drag_mode",["command",function(){return function(a,b){var c=_.deepCopy(b);return _.deepExtend(c,{name:"Ruler Drag",group:"Ruler",template:"ruler.html",enter:function(a){a.game.ruler.state.origin=null,a.game.ruler.state.target=null},Drag:function(a,b,c,d,e,f,g){var h=Math.sqrt(f*f+g*g),i=h;a.game.ruler.state.range>0&&(i=Math.min(10*a.game.ruler.state.range,h));var j=a.game.ruler.state.x1+(d-a.game.ruler.state.x1)*i/h,k=a.game.ruler.state.y1+(e-a.game.ruler.state.y1)*i/h;a.game.ruler.setEnd(j,k)},DragEnd:function(b,c,d,e,f,g,h){var i=Math.sqrt(g*g+h*h),j=i;b.game.ruler.state.range>0&&(j=Math.min(10*b.game.ruler.state.range,i));var k=b.game.ruler.state.x1+(e-b.game.ruler.state.x1)*j/i,l=b.game.ruler.state.y1+(f-b.game.ruler.state.y1)*j/i;b.game.ruler.endDraging(k,l),a.goTo("ruler",b)}}),c}}]).factory("ruler_origin_mode",["command",function(){return function(a,b){var c=_.deepCopy(b);return _.deepExtend(c,{name:"Ruler Origin",group:"Ruler",template:"ruler_origin.html",Click:function(b,c,d){if("Model"!==d.event)return!1;var e=d.target;return b.game.ruler.state.origin=e.state.id,b.game.ruler.setStart(e.state.x,e.state.y),b.game.ruler.state.active=!1,b.game.ruler.state.target=null,b.game.ruler.sendStateCmd(),a.goTo("ruler",b),!0}}),c}}]).factory("ruler_target_mode",["command",function(){return function(a,b){var c=_.deepCopy(b);return _.deepExtend(c,{name:"Ruler Target",group:"Ruler",template:"ruler_target.html",Click:function(b,c,d){if("Model"!==d.event)return!1;var e=d.target;if(b.game.ruler.state.origin===e.state.id)return!0;b.game.ruler.state.target=e.state.id;var f,g=b.game.ruler,h=g.state.x1,i=g.state.y1,j=e.state.x,k=e.state.y;g.state.origin&&(f=b.game.models[g.state.origin],h=f.state.x,i=f.state.y);var l=Math.atan2(j-h,i-k);f&&(h+=f.info.r*Math.sin(l),i-=f.info.r*Math.cos(l)),j-=e.info.r*Math.sin(l),k+=e.info.r*Math.cos(l);var m=j-h,n=k-i,o=Math.sqrt(m*m+n*n),p=o;return b.game.ruler.state.range>0&&(b.game.ruler.state.target_in_range=p<=10*b.game.ruler.state.range,p=Math.min(10*b.game.ruler.state.range,o)),j=h+(j-h)*p/o,k=i+(k-i)*p/o,b.game.ruler.setStart(h,i),b.game.ruler.setEnd(j,k),b.game.ruler.refresh(),b.game.ruler.state.active=!0,b.game.ruler.sendStateCmd(),a.goTo("ruler",b),!0}}),c}}]),angular.module("vassalApp.services").factory("selection_drag_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"Selection Drag",template:"selection_drag.html",Drag:function(a,b,c,d,e,f,g){this.x=c.start_x,this.width=f,this.width<0&&(this.width=-this.width,this.x=this.x-this.width),this.y=c.start_y,this.height=g,this.height<0&&(this.height=-this.height,this.y=this.y-this.height)},DragEnd:function(c,e){if(this.Drag.apply(this,Array.prototype.slice.call(arguments)),this.width>0&&this.height>0){var f=[];_.each(c.game.models,function(a){var b=a.state.x,c=a.state.y;d.x<=b&&b<=d.x+d.width&&d.y<=c&&c<=d.y+d.height&&f.push(a.state.id)}),e.ctrlKey||c.force.ctrl?(c.game.newCommand(a("addToSelection",f)),c.model_view.label=null,c.model_view.unit=null,1===c.game.selection.length&&(c.model_view.label=c.game.models[c.game.selection[0]].state.label,c.model_view.unit=c.game.models[c.game.selection[0]].state.unit)):(c.game.newCommand(a("setSelection",f)),c.model_view.label=null,c.model_view.unit=null,1===c.game.selection.length&&(c.model_view.label=c.game.models[c.game.selection[0]].state.label,c.model_view.unit=c.game.models[c.game.selection[0]].state.unit))}this.width=0,this.height=0,b.goTo("default",c)}}),d}}]),angular.module("vassalApp.services").factory("template_drag_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"Template Drag",group:"Template",template:"template.html",Drag:function(a,b,c,d,e,f,g){a.game.id&&a.game.templates.active.draging(a.game,f,g)},DragEnd:function(c,d,e,f,g,h,i){c.game.id&&(c.game.newCommand(a("dragActiveTemplate",h,i)),c.game.templates.active=e.target,b.goTo("template",c))}}),d}}]).factory("template_origin_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"Template Origin",group:"Template",template:"template_origin.html",Click:function(c,d,e){if(c.game.id){if("Model"!==e.event)return!1;var f=e.target,g=c.game.templates.active;return g.origin=f.state.id,c.game.newCommand("aoe"===g.type?a("onActiveTemplate","refresh"):a("onActiveTemplate","refresh")),b.goTo("template",c),!0}}}),d}}]).factory("template_target_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"Template Target",group:"Template",template:"template_target.html",Click:function(c,d,e){if(c.game.id){if("Model"!==e.event)return!1;var f,g,h=e.target,i=c.game.templates.active;if("aoe"===i.type)f=h.state.x,g=h.state.y,c.game.newCommand(a("onActiveTemplate","set",f,g,c.game.templates.active.rot));else{if(i.origin&&i.origin===h.state.id)return;var j;i.origin&&c.game.models[i.origin]&&(j=c.game.models[i.origin]);var k=j?j.state.x:i.x,l=j?j.state.y:i.y,m=h.state.x,n=h.state.y,o=180*Math.atan2(m-k,l-n)/Math.PI;f=j?j.state.x+j.info.r*Math.sin(o*Math.PI/180):i.x,g=j?j.state.y-j.info.r*Math.cos(o*Math.PI/180):i.y,c.game.newCommand(a("onActiveTemplate","set",f,g,o))}return b.goTo("template",c),!0}}}),d}}]).factory("template_create_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"Template Create",template:"template_create.html",MouseMove:function(a,b,c,e){a.game.id&&(d.x=c,d.y=e)},Click:function(c,e,f,g,h){if(c.game.id){switch(d.x=g,d.y=h,d.rot=0,c.game.newCommand(a("createTemplate",d)),f.event){case"Model":var i=f.target,j=c.game.templates.active;"aoe"===j.type&&c.game.newCommand(a("onActiveTemplate","set",i.state.x,i.state.y,j.rot)),"spray"===j.type&&(j.origin=i.state.id,c.game.newCommand(a("onActiveTemplate","refresh")))}return b.goTo("template",c),!0}}}),d}}]).factory("template_locked_mode",["command",function(a){return function(b,c){var d=_.deepCopy(c);return _.deepExtend(d,{name:"Template Locked",group:"Template",template:"template_locked.html",enter:function(a){a.game.templates.active.locked||b.goTo("template",a)},L:function(c){c.game.id&&(c.game.newCommand(a("onActiveTemplate","toggleLocked")),b.goTo("template",c))},Delete:function(c){c.game.id&&(c.game.newCommand(a("deleteActiveTemplate")),b.goTo("default",c))},"Ctrl D":function(a){this.Delete(a)},Click:function(a,c,d){switch(d.event){case"Template":return a.game.templates.active===d.target?(a.game.templates.active=null,b.goTo("default",a)):(a.game.templates.active=d.target,b.goTo("template",a)),!0;case"Model":return a.game.templates.active=null,b["default"].Click.apply(b["default"],Array.prototype.slice.call(arguments)),b.goTo("default",a),!0;case"Board":return a.game.templates.active=null,b.goTo("default",a),!0}return!1}}),d}}]).factory("template_mode",["command",function(a){return function(b){var c=_.deepCopy(b.template_locked);return _.deepExtend(c,{name:"Template",group:"Template",template:"template.html",enter:function(a){a.game.templates.active.locked&&b.goTo("template_locked",a)},D:function(b){if(b.game.id&&"aoe"===b.game.templates.active.type){var c=b.game.templates.active,d=b.game.rollDeviation(c.max_deviation),e=60*(d.direction-1)+c.rot,f=c.x+d.distance*Math.sin(e*Math.PI/180),g=c.y-d.distance*Math.cos(e*Math.PI/180);b.game.newCommand(a("onActiveTemplate","reset",f,g,e,c.max_deviation))}},O:function(a){a.game.id&&"wall"!==a.game.templates.active.type&&b.goTo("template_origin",a)},R:function(b){if(b.game.id&&"wall"!==b.game.templates.active.type&&b.game.ruler.state.active){var c;b.game.ruler.state.target&&b.game.ruler.state.target_in_range&&(c=b.game.models[b.game.ruler.state.target]);var d=c?c.state.x:b.game.ruler.state.x2,e=c?c.state.y:b.game.ruler.state.y2,f=180*Math.atan2(b.game.ruler.state.x2-b.game.ruler.state.x1,-(b.game.ruler.state.y2-b.game.ruler.state.y1))/Math.PI;b.game.newCommand(a("onActiveTemplate","reset",d,e,f,b.game.ruler.state.length/2))}},T:function(a){a.game.id&&"wall"!==a.game.templates.active.type&&b.goTo("template_target",a)},0:function(b){b.game.id&&"spray"===b.game.templates.active.type&&b.game.newCommand(a("onActiveTemplate","toggleSize",10))},3:function(b){b.game.id&&"aoe"===b.game.templates.active.type&&b.game.newCommand(a("onActiveTemplate","toggleSize",3))},4:function(b){b.game.id&&"aoe"===b.game.templates.active.type&&b.game.newCommand(a("onActiveTemplate","toggleSize",4))},5:function(b){b.game.id&&"aoe"===b.game.templates.active.type&&b.game.newCommand(a("onActiveTemplate","toggleSize",5))},6:function(b){b.game.id&&"spray"===b.game.templates.active.type&&b.game.newCommand(a("onActiveTemplate","toggleSize",6))},8:function(b){b.game.id&&"spray"===b.game.templates.active.type&&b.game.newCommand(a("onActiveTemplate","toggleSize",8))},Up:function(b){b.game.id&&b.game.newCommand(a("onActiveTemplate","moveFront",!1))},"Shift Up":function(b){b.game.id&&b.game.newCommand(a("onActiveTemplate","moveFront",!0))},"Ctrl Up":function(b){b.game.id&&b.game.newCommand(a("onActiveTemplate",b.game.board.zoom.flipped?"moveDown":"moveUp",!1))},"Ctrl Shift Up":function(b){b.game.id&&b.game.newCommand(a("onActiveTemplate",b.game.board.zoom.flipped?"moveDown":"moveUp",!0))},Left:function(b){b.game.id&&b.game.newCommand(a("onActiveTemplate","rotateLeft",!1))},"Shift Left":function(b){b.game.id&&b.game.newCommand(a("onActiveTemplate","rotateLeft",!0))},"Ctrl Left":function(b){b.game.id&&b.game.newCommand(a("onActiveTemplate",b.game.board.zoom.flipped?"moveRight":"moveLeft",!1))},"Ctrl Shift Left":function(b){b.game.id&&b.game.newCommand(a("onActiveTemplate",b.game.board.zoom.flipped?"moveRight":"moveLeft",!0))},Right:function(b){b.game.id&&b.game.newCommand(a("onActiveTemplate","rotateRight",!1))},"Shift Right":function(b){b.game.id&&b.game.newCommand(a("onActiveTemplate","rotateRight",!0))},"Ctrl Right":function(b){b.game.id&&b.game.newCommand(a("onActiveTemplate",b.game.board.zoom.flipped?"moveLeft":"moveRight",!1))},"Ctrl Shift Right":function(b){b.game.id&&b.game.newCommand(a("onActiveTemplate",b.game.board.zoom.flipped?"moveLeft":"moveRight",!0))},Down:function(b){b.game.id&&b.game.newCommand(a("onActiveTemplate","moveBack",!1))},"Shift Down":function(b){b.game.id&&b.game.newCommand(a("onActiveTemplate","moveBack",!0))},"Ctrl Down":function(b){b.game.id&&b.game.newCommand(a("onActiveTemplate",b.game.board.zoom.flipped?"moveUp":"moveDown",!1))},"Ctrl Shift Down":function(b){b.game.id&&b.game.newCommand(a("onActiveTemplate",b.game.board.zoom.flipped?"moveUp":"moveDown",!0))},DragStart:function(a,c,d){return a.game.id?"Template"===d.event?(a.game.templates.active=d.target,d.target.startDraging(),b.goTo("template_drag",a),!0):!1:void 0},Click:function(c,d,e){if(c.game.id){switch(e.event){case"Template":return c.game.templates.active===e.target?(c.game.templates.active=null,b.goTo("default",c)):(c.game.templates.active=e.target,b.goTo("template",c)),!0;case"Model":var f,g,h=e.target,i=c.game.templates.active;if(d.ctrlKey)return"wall"===c.game.templates.active.type?!0:(i.origin=h.state.id,c.game.newCommand(a("onActiveTemplate","refresh")),!0);if(d.shiftKey){if(i.origin===h.state.id)return!0;if("aoe"===i.type)return f=h.state.x,g=h.state.y,c.game.newCommand(a("onActiveTemplate","set",f,g,c.game.templates.active.rot)),!0;var j=c.game.models[i.origin],k=j.state.x,l=j.state.y,m=h.state.x,n=h.state.y,o=180*Math.atan2(m-k,l-n)/Math.PI;return f=j.state.x+j.info.r*Math.sin(o*Math.PI/180),g=j.state.y-j.info.r*Math.cos(o*Math.PI/180),c.game.newCommand(a("onActiveTemplate","set",f,g,o)),!0}c.game.templates.active=null;var p=b["default"].Click.apply(b["default"],Array.prototype.slice.call(arguments));return b.goTo("default",c),p;case"Board":return c.game.templates.active=null,b.goTo("default",c),!0}return!1}}}),c}}]),angular.module("vassalApp.services").factory("netdeck",["$http","$q",function(a){var b={};return a.get("/data/netdeck.json").then(function(a){b.list=a.data},function(a){}),b}]),angular.module("vassalApp.services").factory("scenarios",["$http","$q",function(a,b){var c={};return a.get("/data/scenarios.json").then(function(a){return c.list=a.data,c},function(a){return b.reject(a)})}]),angular.module("vassalApp.services").value("template_base",{refresh:function(a){this.x=Math.max(0,this.x),this.x=Math.min(a.board.width,this.x),this.y=Math.max(0,this.y),this.y=Math.min(a.board.height,this.y)},reset:function(a,b,c,d){this.origin=null,this.set(a,b,c,d)},set:function(a,b,c,d){this.x=b,this.y=c,this.rot=d,this.refresh(a)},moveFront:function(a,b){var c=b?1:10,d=c*Math.sin(this.rot*Math.PI/180),e=-c*Math.cos(this.rot*Math.PI/180);this.x+=d,this.y+=e,this.refresh(a)},moveBack:function(a,b){var c=b?1:10,d=-c*Math.sin(this.rot*Math.PI/180),e=c*Math.cos(this.rot*Math.PI/180);this.x+=d,this.y+=e,this.refresh(a)},rotateLeft:function(a,b){var c=b?this.drot[0]:this.drot[1];this.rot=this.rot-c,this.refresh(a)},moveLeft:function(a,b){var c=b?1:10;this.x-=c,this.refresh(a)},moveUp:function(a,b){var c=b?1:10;this.y-=c,this.refresh(a)},rotateRight:function(a,b){var c=b?this.drot[0]:this.drot[1];this.rot=this.rot+c,this.refresh(a)},moveRight:function(a,b){var c=b?1:10;this.x+=c,this.refresh(a)},moveDown:function(a,b){var c=b?1:10;this.y+=c,this.refresh(a)},toggleLocked:function(){this.locked=!this.locked,this.origin=null},toggleSize:function(a,b){this.size=b},startDraging:function(){this.startDraging.ref=_.deepCopy(this)},draging:function(a,b,c){this.x=this.startDraging.ref.x+b,this.y=this.startDraging.ref.y+c,this.refresh(a)},overlappingModels:function(){return[]},setLabel:function(a,b){b=b.trim(),b.length<=0||(this.label||(this.label=[]),0<=_.indexOf(this.label,b)||this.label.push(b))},clearLabel:function(a,b){b>=this.label.length||this.label.splice(b,1)},clearAllLabel:function(){this.label=[]},displayLabel:function(){return _.reduce(this.label,function(a,b){return a+" "+b},"")}}).factory("template_aoe",["template_base",function(a){var b=_.defaults({type:"aoe",drot:[10,60],refresh:function(b){if(this.origin&&b.models[this.origin]){var c=b.models[this.origin],d=this.x-c.state.x,e=-(this.y-c.state.y);this.rot=180*Math.atan2(d,e)/Math.PI;var f=Math.sqrt(d*d+e*e);this.max_deviation=(f/2*10>>0)/100}else this.max_deviation=6;a.refresh.apply(this,Array.prototype.slice.call(arguments))},reset:function(b,c,d,e,f){a.reset.apply(this,Array.prototype.slice.call(arguments)),this.max_deviation=f?f:6},rotateLeft:function(){this.origin=null,this.max_deviation=6,a.rotateLeft.apply(this,Array.prototype.slice.call(arguments))},rotateRight:function(){this.origin=null,this.max_deviation=6,a.rotateRight.apply(this,Array.prototype.slice.call(arguments))},overlappingModels:function(a){var b=this;return _.filter(a.models,function(a){var c=b.x-a.state.x,d=b.y-a.state.y;return Math.sqrt(c*c+d*d)<=5*b.size+a.info.r}).map(function(a){return a.state.id})}},a),c=function(a){return _.extend(a,b),void 0===a.stamp&&(a.stamp=Date.now()),a};return c}]).factory("template_spray",["template_base",function(a){var b=_.defaults({type:"spray",drot:[2,12],max_deviation:6,refresh:function(b){if(this.origin&&b.models[this.origin]){var c=b.models[this.origin];this.x=c.state.x+c.info.r*Math.sin(this.rot*Math.PI/180),this.y=c.state.y-c.info.r*Math.cos(this.rot*Math.PI/180)}a.refresh.apply(this,Array.prototype.slice.call(arguments))},moveFront:function(){this.origin=null,a.moveFront.apply(this,Array.prototype.slice.call(arguments))},moveBack:function(){this.origin=null,a.moveBack.apply(this,Array.prototype.slice.call(arguments))},moveLeft:function(){this.origin=null,a.moveLeft.apply(this,Array.prototype.slice.call(arguments))},moveUp:function(){this.origin=null,a.moveUp.apply(this,Array.prototype.slice.call(arguments))},moveRight:function(){this.origin=null,a.moveRight.apply(this,Array.prototype.slice.call(arguments))},moveDown:function(){this.origin=null,a.moveDown.apply(this,Array.prototype.slice.call(arguments))},startDraging:function(){this.origin=null,a.startDraging.apply(this,Array.prototype.slice.call(arguments))},draging:function(){this.origin=null,a.draging.apply(this,Array.prototype.slice.call(arguments))}},a),c=function(a){return _.extend(a,b),void 0===a.stamp&&(a.stamp=Date.now()),a};return c}]).factory("template_wall",["template_base",function(a){var b=_.defaults({type:"wall",drot:[2,12]},a),c=function(a){return _.extend(a,b),void 0===a.stamp&&(a.stamp=Date.now()),a};return c}]).factory("template",["template_aoe","template_spray","template_wall",function(a,b,c){var d={aoe:a,spray:b,wall:c},e=function(a){return _.isFunction(d[a.type])?d[a.type](a):void 0};return e}]),angular.module("vassalApp.services").factory("twoPlayerClock",["clock","$timeout",function(a,b){return function(c){var d,e=function(){f.update()},f={state:"stopped",active_player:"player1",clocks:{player1:a(),player2:a()},isValid:function(){return this.clocks.player1.isValid()&&this.clocks.player2.isValid()},start:function(){return"stopped"===this.state&&this.isValid()?(this.clocks.player1.start(),this.clocks.player2.start(),this.state="running",d=b(e,1e3),!0):!1},stop:function(){return b.cancel(d),"running"===this.state?(this.state="stopped",this.clocks[this.active_player].stop(),!0):!1},update:function(){"running"===this.state&&(this.clocks[this.active_player].update(),d=b(e,1e3))},switchPlayer:function(){"running"==this.state&&this.clocks[this.active_player].stop(),this.active_player="player1"==this.active_player?"player2":"player1","running"==this.state&&this.clocks[this.active_player].start()},updateReserve:function(a){_.deepExtend(this.clocks.player1.reserve,a.clocks.player1.reserve),_.deepExtend(this.clocks.player2.reserve,a.clocks.player2.reserve)},checkForPlayerSwitch:function(a){this.active_player!=a.active_player&&(this.active_player=a.active_player,this.clocks.player1.start(),this.clocks.player2.start())},checkForStateChange:function(a){this.state!=a.state&&(this.state=a.state,"running"==a.state&&(this.clocks.player1.start(),this.clocks.player2.start(),d=b(e,1e3)))},checkForUpdate:function(a){this.updateReserve(a),this.checkForPlayerSwitch(a),this.checkForStateChange(a)}};return _.isObject(c)&&_.deepExtend(f,c),"running"===f.state&&(d=b(e,1e3)),f}}]),angular.module("vassalApp.services").service("user",["$http","$rootScope",function(a,b){function c(){d&&d.close();var a="/api/users/"+e.id+"/subscribe";e.wall&&(a+="?close=true"),d=new EventSource(a),d.onmessage=function(a){},d.addEventListener("chat",function(a){var c=JSON.parse(a.data);e.chat.push(c),c.from!==e.id&&b.$broadcast("user_chat",c),b.$digest()}),d.onerror=function(a){return a.target.readyState===a.target.CLOSED?(e.id=null,void b.$digest()):(d.close(),void c())}}var d,e={chat:[],last_chat:null,create:function(){this.id=null,this.stamp=Date.now(),a.post("/api/users",this).then(function(a){_.extend(e,a.data),localStorage.setItem("vassal_user",JSON.stringify(e)),c()},function(a){})},refresh:function(){this.id&&a.put("/api/users/"+this.id,this).then(function(a){localStorage.setItem("vassal_user",JSON.stringify(e))},function(a){})},validate:function(){this.id&&a.get("/api/users/"+this.id).then(function(a){a.data.stamp===f.stamp?(_.extend(e,a.data),localStorage.setItem("vassal_user",JSON.stringify(e)),c()):e.create()},function(a){e.create()})}},f=null;try{f=JSON.parse(localStorage.getItem("vassal_user")),_.extend(e,f)}catch(g){}return e.validate(),e}]),angular.module("vassalApp.services").factory("users",["$http","$rootScope","user",function(a,b,c){function d(){var a=e;c.wall&&(a+="?close=true"),f.source=new EventSource(a),f.source.onmessage=function(a){var c=JSON.parse(a.data);f.list=c,b.$digest()},f.source.onerror=function(a){return a.target.readyState===a.target.CLOSED?(f.list=[],window.setTimeout(d,5e3),void b.$digest()):(f.source.close(),void d())}}var e="/api/users/subscribe",f={list:[]};return d(),f}]);